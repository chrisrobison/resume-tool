TESTING
=======

This document describes local testing, running the static server, and using the AI proxy for `parse-job` flows.

Quick start
-----------

- Install dev dependencies: `npm ci` (if you need to run Cypress locally).
- Start a static server: `npm run serve` (serves `.` on `http://localhost:8080`).
- Run a single Cypress spec (local):
  - `CYPRESS_BASE_URL=http://localhost:8080 npx cypress run --spec 'cypress/e2e/basic-ui.cy.js'`

Overriding Cypress baseUrl
--------------------------

Cypress base URL defaults to `http://localhost:8080` for local development. To override it (for example in CI), set the `CYPRESS_BASE_URL` environment variable:

- Unix/macOS: `CYPRESS_BASE_URL=https://example.com npx cypress run --spec 'cypress/e2e/basic-ui.cy.js'`
- Windows (PowerShell): `$env:CYPRESS_BASE_URL='https://example.com'; npx cypress run --spec 'cypress/e2e/basic-ui.cy.js'`

Visual tests (opt-in)
---------------------

Visual regression tests are intentionally opt-in. To run the visual suite set either `--env visual=1` or the environment variable `CYPRESS_VISUAL=1`.

- Example: `CYPRESS_BASE_URL=http://localhost:8080 npx cypress run --spec 'cypress/e2e/visual-regression.cy.js' --env visual=1`
- Or: `CYPRESS_VISUAL=1 CYPRESS_BASE_URL=http://localhost:8080 npx cypress run --spec 'cypress/e2e/visual-regression.cy.js'`

AI proxy and `.env`
-------------------

This project provides a small server-side proxy `ai-proxy.php` that can use a `.env` file to supply API keys. A sample `.env.example` is included.

Steps to test parse-job flows locally:

1. Ensure PHP is available (for `ai-proxy.php`) or run the Node server in `server/` if available.
2. Copy `.env.example` to `.env` and populate your API keys (do NOT commit `.env`).
   - `cp .env.example .env`
   - Edit `.env` and add your real `OPENAI_API_KEY` and/or `ANTHROPIC_API_KEY`.
3. Start the static server: `npm run serve` (serves `http://localhost:8080`).
4. Open the test harness `test-ai-proxy.html` or run the import flow in the UI that triggers `ai-proxy.php`.

Notes on `.env.example`
-----------------------

The repository includes `.env.example` with the following keys documented:

- `ANTHROPIC_API_KEY` — optional, used by Claude/Anthropic backend.
- `OPENAI_API_KEY` — optional, used by OpenAI requests.
- `ALLOWED_ORIGINS` — CORS allowed origins for `ai-proxy.php` (default `*`).
- `CLAUDE_MODEL` / `OPENAI_MODEL` — defaults for server-side requests.

CI notes
--------

- Use `npm run test:ci` in CI pipelines. This starts the static server in background then runs headless tests.
- Visual tests should only be enabled when you intentionally want to produce baseline screenshots.

Troubleshooting
---------------

- If Cypress cannot connect, verify `CYPRESS_BASE_URL` and that `npm run serve` is running.
- If AI proxy requests fail, check `ai.log` (generated by `ai-proxy.php`) and ensure API keys are set in `.env`.

