<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Hunt Manager</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="jobs.css">
    <!-- HTML2PDF.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1><img src="logo.svg" height="32" style="position:relative;top:8px;"> Job Hunt Manager</h1>
                <div class="subtitle">Organize your job search</div>
            </div>
            
            <nav class="sidebar-nav">
                <a href="#" class="nav-item active" data-section="jobs">
                    <i class="fas fa-briefcase"></i>
                    <span>Jobs</span>
                </a>
                <a href="#" class="nav-item" data-section="resumes">
                    <i class="fas fa-file-alt"></i>
                    <span>Resumes</span>
                </a>
                <a href="#" class="nav-item" data-section="letters">
                    <i class="fas fa-envelope"></i>
                    <span>Letters</span>
                </a>
                <a href="#" class="nav-item" data-section="ai-assistant">
                    <i class="fas fa-magic"></i>
                    <span>AI Assistant</span>
                </a>
                <a href="#" class="nav-item" data-section="ai">
                    <i class="fas fa-robot"></i>
                    <span>AI History</span>
                </a>
                 <a href="#" class="nav-item" data-section="help" id="help-nav">
                    <i class="fas fa-question-circle"></i>
                    <span>Help</span>
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <button class="settings-btn" id="settings-btn">
                    <i class="fas fa-cog"></i> Settings
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="main-header">
                <h2 id="section-title">Jobs</h2>
                <div class="header-actions">
                    <button class="btn btn-primary" id="import-job-btn" style="display: none;">
                        <i class="fas fa-download"></i>
                        Import Job
                    </button>
                    <button class="btn btn-primary" id="import-resume-btn" style="display: none;">
                        <i class="fas fa-file-import"></i>
                        Import Resume
                    </button>
                    <button class="btn btn-success" id="add-item-btn">
                        <i class="fas fa-plus"></i>
                        <span id="add-item-text">Add Job</span>
                    </button>
                </div>
            </div>

            <div class="content-panels">
                <!-- Items List Panel -->
                <div class="items-panel" id="items-panel">
                    <div class="items-header" id="items-header">Jobs</div>
                    <div class="items-list" id="items-list">
                        <!-- Items will be populated here -->
                    </div>
                </div>

                <!-- Details Panel -->
                <div class="details-panel" id="details-panel">
                    <div class="details-content" id="details-content">
                        <div class="empty-state">
                            <i class="fas fa-briefcase"></i>
                            <h3>Select a job to view details</h3>
                            <p>Choose a job from the list to view and edit its information</p>
                        </div>
                    </div>
                </div>

                <!-- Settings Panel -->
                <div id="settings-panel" class="settings-panel" style="display:none; width:100%;">
                    <settings-manager></settings-manager>
                </div>

                <!-- AI Assistant Panel -->
                <div id="ai-assistant-panel" class="ai-assistant-panel" style="display:none; width:100%;">
                    <ai-assistant-worker></ai-assistant-worker>
                </div>

                <!-- Help Panel -->
                <div id="help-panel" class="help-panel" style="display:none; width:100%;">
                    <style>
                        .help-container {
                            max-width: 800px;
                            margin: 40px auto;
                            background: #fff;
                            border-radius: 12px;
                            box-shadow: 0 4px 24px rgba(44,62,80,0.08);
                            padding: 2.5rem 2rem;
                        }
                        .help-container h1 {
                            font-size: 2.2rem;
                            margin-bottom: 0.5em;
                        }
                        .help-container h2 {
                            margin-top: 2em;
                            font-size: 1.3rem;
                            color: #2980b9;
                        }
                        .help-container ul, .help-container ol {
                            margin-left: 1.5em;
                        }
                        .help-container code {
                            background: #f4f4f4;
                            border-radius: 4px;
                            padding: 2px 6px;
                            font-size: 0.98em;
                        }
                        .help-container .tip {
                            background: #eafaf1;
                            border-left: 4px solid #27ae60;
                            padding: 0.7em 1em;
                            margin: 1.5em 0;
                            border-radius: 6px;
                            color: #145a32;
                        }
                    </style>
                    <div class="help-container">
                        <h1><i class="fas fa-question-circle"></i> Job Hunt Manager Help & Usage Guide</h1>
                        <p>Welcome to the Job Hunt Manager! This guide will help you get the most out of the tool.</p>

                        <h2>Getting Started</h2>
                        <ol>
                            <li><strong>Add Jobs:</strong> Click <b>Add Job</b> to enter job details manually, or use <b>Import Job</b> to extract details from a job posting URL or description.</li>
                            <li><strong>Track Status:</strong> Update the status of each job (e.g., saved, applied, interviewing, etc.) as your search progresses.</li>
                            <li><strong>Manage Resumes:</strong> Store and edit multiple resumes. Tailor resumes for specific jobs using the AI features.</li>
                            <li><strong>Generate Cover Letters:</strong> Use the AI tool to create personalized cover letters for each job application.</li>
                        </ol>

                        <h2>Sections Overview</h2>
                        <ul>
                            <li><b>Jobs:</b> List and manage all job opportunities. Click a job to view or edit details.</li>
                            <li><b>Resumes:</b> Store, edit, and tailor resumes. Use the visual editor for easy updates.</li>
                            <li><b>Letters:</b> Manage cover letters and other correspondence.</li>
                            <li><b>AI History:</b> View a log of all AI-powered actions (resume tailoring, letter generation, etc.).</li>
                        </ul>

                        <h2>AI Features</h2>
                        <ul>
                            <li><b>Tailor Resume:</b> Select a job and a base resume, then use the AI to generate a tailored resume for that job.</li>
                            <li><b>Generate Cover Letter:</b> Optionally generate a cover letter at the same time as tailoring a resume.</li>
                            <li><b>API Key Required:</b> Set your API key in <b>Settings</b> to use AI features. You can use OpenAI (ChatGPT) or Anthropic (Claude).</li>
                        </ul>

                        <h2>Tips & Best Practices</h2>
                        <ul>
                            <li>Regularly save your data. All information is stored in your browser's local storage.</li>
                            <li>Use the <b>Import Job</b> feature to quickly add jobs from URLs or descriptions.</li>
                            <li>Keep your resumes up to date and tailor them for each application.</li>
                            <li>Check the <b>AI History</b> tab to review past AI actions and outputs.</li>
                        </ul>

                        <div class="tip">
                            <b>Need more help?</b> If you have questions or encounter issues, please contact the developer or check for updates.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Generic Form Modal -->
    <div class="modal-backdrop hidden" id="form-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="form-modal-title">Add Item</h3>
                <button class="modal-close" id="form-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="generic-form">
                    <!-- Form fields will be generated here -->
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" id="form-cancel">Cancel</button>
                <button type="button" class="btn btn-primary" id="form-save">Save</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-backdrop hidden" id="settings-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Settings</h3>
                <button class="modal-close" id="settings-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="api-type">AI Service</label>
                    <select class="form-input" id="api-type">
                        <option value="claude">Claude (Anthropic)</option>
                        <option value="chatgpt">ChatGPT (OpenAI)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="api-key">API Key</label>
                    <input type="password" class="form-input" id="api-key" placeholder="Enter your API key">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="use-direct-api"> Use direct API calls (browser-based)
                    </label>
                    <div style="font-size: 12px; color: #7f8c8d; margin-top: 5px;">
                        When enabled, API calls are made directly from your browser. Otherwise, they go through the local server.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" id="settings-cancel">Cancel</button>
                <button type="button" class="btn btn-primary" id="settings-save">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Import Job Modal -->
    <div class="modal-backdrop hidden" id="import-job-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Import Job from URL or Description</h3>
                <button class="modal-close" id="import-job-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Import Method</label>
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="radio" name="import-method" value="url" id="import-method-url" checked>
                            <span>Job URL</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="radio" name="import-method" value="description" id="import-method-description">
                            <span>Job Description</span>
                        </label>
                    </div>
                </div>

                <div class="form-group" id="import-url-section">
                    <label class="form-label" for="import-job-url">Job Posting URL</label>
                    <input type="url" class="form-input" id="import-job-url" placeholder="https://example.com/job-posting">
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        Paste the URL of the job posting (LinkedIn, Indeed, company website, etc.)
                    </div>
                </div>

                <div class="form-group hidden" id="import-description-section">
                    <label class="form-label" for="import-job-description">Job Description</label>
                    <textarea class="form-input form-textarea" id="import-job-description" rows="10" placeholder="Paste the complete job description here..."></textarea>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        Copy and paste the entire job description including requirements, responsibilities, and company information
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="import-custom-instructions">Additional Instructions (Optional)</label>
                    <textarea class="form-input form-textarea" id="import-custom-instructions" rows="2" placeholder="Any specific parsing requirements or additional information..."></textarea>
                </div>

                <div id="import-api-warning" class="hidden" style="padding: 10px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; margin: 10px 0;">
                    <strong>⚠️ API Key Required</strong><br>
                    Please configure your API key in Settings before using import features.
                </div>

                <div id="import-progress" class="hidden" style="padding: 15px; text-align: center;">
                    <div style="margin-bottom: 10px;">
                        <i class="fas fa-download fa-spin" style="font-size: 24px; color: #3498db;"></i>
                    </div>
                    <div id="import-progress-text">Importing job information...</div>
                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                        Analyzing content and extracting job details...
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" id="import-job-cancel">Cancel</button>
                <button type="button" class="btn btn-primary" id="import-job-submit">
                    <i class="fas fa-download"></i> Import Job
                </button>
            </div>
        </div>
    </div>

    <!-- Import Resume Modal -->
    <div class="modal-backdrop hidden" id="import-resume-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Import Resume.json</h3>
                <button class="modal-close" id="import-resume-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Import Method</label>
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="radio" name="resume-import-method" value="paste" id="resume-import-method-paste" checked>
                            <span>Paste JSON</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="radio" name="resume-import-method" value="file" id="resume-import-method-file">
                            <span>Upload File</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="radio" name="resume-import-method" value="url" id="resume-import-method-url">
                            <span>From URL</span>
                        </label>
                    </div>
                </div>

                <div class="form-group" id="resume-paste-section">
                    <label class="form-label" for="resume-json-input">Paste JSON</label>
                    <textarea class="form-input form-textarea" id="resume-json-input" rows="10" placeholder="Paste your resume.json content here..."></textarea>
                </div>

                <div class="form-group hidden" id="resume-file-section">
                    <label class="form-label" for="resume-file-input">Upload JSON File</label>
                    <div id="resume-drag-drop-area" class="drag-drop-area" style="border: 2px dashed #ddd; padding: 40px; text-align: center; border-radius: 8px; cursor: pointer;">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #ccc; margin-bottom: 16px;"></i>
                        <p>Drag & drop your resume.json file here or click to browse</p>
                        <input type="file" id="resume-file-input" accept=".json" style="display: none;">
                    </div>
                    <div id="resume-file-name" class="hidden"></div>
                </div>

                <div class="form-group hidden" id="resume-url-section">
                    <label class="form-label" for="resume-url-input">JSON URL</label>
                    <input type="url" class="form-input" id="resume-url-input" placeholder="https://example.com/resume.json">
                </div>

                <div class="form-group">
                    <label class="form-label" for="resume-name-input">Resume Name</label>
                    <input type="text" class="form-input" id="resume-name-input" placeholder="My Resume" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" id="import-resume-cancel">Cancel</button>
                <button type="button" class="btn btn-primary" id="import-resume-submit">
                    <i class="fas fa-file-import"></i> Import Resume
                </button>
            </div>
        </div>
    </div>

    <!-- AI Generation Modal -->
    <div class="modal-backdrop hidden" id="ai-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">AI Resume Tailoring & Cover Letter Generation</h3>
                <button class="modal-close" id="ai-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Job Details</label>
                    <div id="ai-job-details" class="card" style="padding: 15px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px;">
                        <!-- Job details will be populated here -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="ai-base-resume">Select Base Resume</label>
                    <select class="form-input" id="ai-base-resume" required>
                        <option value="">Choose a resume to tailor...</option>
                        <!-- Resume options will be populated here -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="ai-custom-instructions">Custom Instructions (Optional)</label>
                    <textarea class="form-input form-textarea" id="ai-custom-instructions" rows="3" placeholder="Any specific requirements or preferences for the tailoring..."></textarea>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="ai-generate-cover-letter" checked> Generate cover letter
                    </label>
                </div>

                <div id="ai-api-warning" class="hidden" style="padding: 10px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; margin: 10px 0;">
                    <strong>⚠️ API Key Required</strong><br>
                    Please configure your API key in Settings before using AI features.
                </div>

                <div id="ai-progress" class="hidden" style="padding: 15px; text-align: center;">
                    <div style="margin-bottom: 10px;">
                        <i class="fas fa-robot fa-spin" style="font-size: 24px; color: #3498db;"></i>
                    </div>
                    <div id="ai-progress-text">Processing with AI...</div>
                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                        This may take 30-60 seconds depending on the AI service.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" id="ai-cancel">Cancel</button>
                <button type="button" class="btn btn-success" id="ai-generate">
                    <i class="fas fa-robot"></i> Generate
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Resume Editor Component -->
    <script type="module" src="./components/resume-editor.js"></script>
    <script type="module" src="./components/resume-viewer.js"></script>
    <script type="module" src="./components/global-store.js"></script>
    <script type="module" src="./components/settings-manager.js"></script>
    <script type="module" src="./components/ai-assistant-worker.js"></script>
    <script type="module" src="./js/ai-service.js"></script>
    <script type="module" src="./js/store.js"></script>

    <!-- Global Store Instance -->
    <global-store></global-store>

    <!-- Job Hunt Manager JavaScript -->
    <script type="module">
        import { setState, getState } from './js/store.js';
        
        // Data structure for the job hunt manager
        const defaultData = {
            jobs: [],
            resumes: [],
            letters: [],
            ai: []
        };

        // Current state
        let currentSection = 'jobs';
        let currentItem = null;
        let data = loadData();

        // Utility function to escape HTML content
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.toString().replace(/[&<>"']/g, m => map[m]);
        }

        // Utility: format date for datetime-local input
        function formatDateForInput(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            if (isNaN(d.getTime())) return '';
            const pad = n => n.toString().padStart(2, '0');
            return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
        }

        // Utility function to sanitize JSON for form display
        function sanitizeJsonForForm(jsonObj) {
            if (typeof jsonObj === 'string') {
                try {
                    jsonObj = JSON.parse(jsonObj);
                } catch (e) {
                    return jsonObj; // Return as-is if not valid JSON
                }
            }
            return JSON.stringify(jsonObj, null, 2);
        }

        // Job schema
        const jobSchema = {
            id: { type: 'hidden', required: true },
            company: { type: 'text', label: 'Company', required: true },
            position: { type: 'text', label: 'Position', required: true },
            status: { 
                type: 'select', 
                label: 'Status',
                options: ['saved', 'applied', 'interviewing', 'offered', 'rejected', 'accepted', 'declined'],
                required: true
            },
            datePosted: { type: 'date', label: 'Date Posted' },
            dateApplied: { type: 'date', label: 'Date Applied' },
            description: { type: 'textarea', label: 'Short Description', rows: 3 },
            jobDetails: { type: 'textarea', label: 'Job Details', rows: 8 },
            location: { type: 'text', label: 'Location' },
            contactName: { type: 'text', label: 'Contact Name' },
            contactEmail: { type: 'email', label: 'Contact Email' },
            contactPhone: { type: 'tel', label: 'Contact Phone' },
            url: { type: 'url', label: 'Job URL' },
            resumeId: { 
                type: 'select', 
                label: 'Associated Resume',
                options: () => data.resumes.map(r => ({ value: r.id, label: r.name || 'Untitled Resume' }))
            },
            notes: { type: 'textarea', label: 'Notes', rows: 4 }
        };

        // Resume schema - using resume-editor component for content editing
        const resumeSchema = {
            id: { type: 'hidden', required: true },
            name: { type: 'text', label: 'Resume Name', required: true },
            content: { type: 'resume-editor', label: 'Resume Content' },
            dateCreated: { type: 'datetime-local', label: 'Date Created', readonly: true },
            dateModified: { type: 'datetime-local', label: 'Last Modified', readonly: true }
        };

        // Cover letter schema
        const letterSchema = {
            id: { type: 'hidden', required: true },
            name: { type: 'text', label: 'Letter Name', required: true },
            type: { 
                type: 'select', 
                label: 'Letter Type',
                options: ['cover_letter', 'thank_you', 'follow_up', 'networking'],
                required: true
            },
            content: { type: 'textarea', label: 'Letter Content', rows: 15 },
            jobId: { 
                type: 'select', 
                label: 'Associated Job',
                options: () => data.jobs.map(j => ({ value: j.id, label: `${j.position} at ${j.company}` }))
            },
            dateCreated: { type: 'datetime-local', label: 'Date Created', readonly: true }
        };

        // AI interaction schema
        const aiSchema = {
            id: { type: 'hidden', required: true },
            type: { type: 'text', label: 'Interaction Type', readonly: true },
            service: { type: 'text', label: 'AI Service', readonly: true },
            prompt: { type: 'textarea', label: 'Prompt', rows: 5, readonly: true },
            response: { type: 'textarea', label: 'Response', rows: 10, readonly: true },
            timestamp: { type: 'datetime-local', label: 'Timestamp', readonly: true },
            jobId: { type: 'text', label: 'Related Job ID', readonly: true }
        };

        const schemas = {
            jobs: jobSchema,
            resumes: resumeSchema,
            letters: letterSchema,
            ai: aiSchema
        };

        // Initialize the application
        function init() {
            setupEventListeners();
            switchSection('jobs');
            syncWithGlobalStore();
        }

        // Load data from localStorage
        function loadData() {
            const stored = localStorage.getItem('jobHuntData');
            return stored ? JSON.parse(stored) : defaultData;
        }

        // Sync data with global store
        function syncWithGlobalStore() {
            // Wait for global store to be ready
            setTimeout(() => {
                setState({
                    jobs: data.jobs || [],
                    resumes: data.resumes || [],
                    coverLetters: data.letters || []
                }, 'jobs-html-sync');
            }, 100);
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('jobHuntData', JSON.stringify(data));
            // Also sync with global store
            setState({
                jobs: data.jobs || [],
                resumes: data.resumes || [],
                coverLetters: data.letters || []
            }, 'jobs-html-save-sync');
        }

        // Generate unique ID
        function generateId() {
            return `${currentSection}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        }

        // Setup event listeners
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    // Only handle section switching for items with data-section
                    const section = item.dataset.section;
                    if (section) {
                        e.preventDefault();
                        switchSection(section);
                    }
                    // If no data-section (e.g., Help), let the default link behavior occur
                });
            });

            // Add item button
            document.getElementById('add-item-btn').addEventListener('click', () => {
                addNewItem();
            });

            // Import job button
            document.getElementById('import-job-btn').addEventListener('click', () => {
                openImportJobModal();
            });

            // Import resume button
            document.getElementById('import-resume-btn').addEventListener('click', () => {
                openImportResumeModal();
            });

            // Modal events
            document.getElementById('form-modal-close').addEventListener('click', closeModal);
            document.getElementById('form-cancel').addEventListener('click', closeModal);
            document.getElementById('form-save').addEventListener('click', saveItem);

            // Settings
            document.getElementById('settings-btn').addEventListener('click', openSettings);
            document.getElementById('settings-modal-close').addEventListener('click', closeSettings);
            document.getElementById('settings-cancel').addEventListener('click', closeSettings);
            document.getElementById('settings-save').addEventListener('click', saveSettings);

            // AI Modal
            document.getElementById('ai-modal-close').addEventListener('click', closeAIModal);
            document.getElementById('ai-cancel').addEventListener('click', closeAIModal);
            document.getElementById('ai-generate').addEventListener('click', processAIGeneration);

            // Import Job Modal
            document.getElementById('import-job-modal-close').addEventListener('click', closeImportJobModal);
            document.getElementById('import-job-cancel').addEventListener('click', closeImportJobModal);
            document.getElementById('import-job-submit').addEventListener('click', processJobImport);
            document.getElementById('import-method-url').addEventListener('change', toggleImportMethod);
            document.getElementById('import-method-description').addEventListener('change', toggleImportMethod);

            // Import Resume Modal
            document.getElementById('import-resume-modal-close').addEventListener('click', closeImportResumeModal);
            document.getElementById('import-resume-cancel').addEventListener('click', closeImportResumeModal);
            document.getElementById('import-resume-submit').addEventListener('click', processResumeImport);
            document.getElementById('resume-import-method-paste').addEventListener('change', toggleResumeImportMethod);
            document.getElementById('resume-import-method-file').addEventListener('change', toggleResumeImportMethod);
            document.getElementById('resume-import-method-url').addEventListener('change', toggleResumeImportMethod);

            // Close modals on backdrop click
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
                backdrop.addEventListener('click', (e) => {
                    if (e.target === backdrop) {
                        backdrop.classList.add('hidden');
                    }
                });
            });
        }

        // Switch between sections
        function switchSection(section) {
            currentSection = section;
            currentItem = null;

            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-section="${section}"]`).classList.add('active');

            // Update header
            const titles = {
                jobs: 'Jobs',
                resumes: 'Resumes', 
                letters: 'Cover Letters',
                ai: 'AI Interactions',
                'ai-assistant': 'AI Assistant',
                settings: 'Settings',
                help: 'Help'
            };
            document.getElementById('section-title').textContent = titles[section] || '';
            document.getElementById('items-header').textContent = titles[section] || '';
            document.getElementById('add-item-text').textContent = `Add ${section.slice(0, -1)}`;

            // Show/hide panels and buttons based on section
            const addBtn = document.getElementById('add-item-btn');
            const importJobBtn = document.getElementById('import-job-btn');
            const importResumeBtn = document.getElementById('import-resume-btn');
            const itemsPanel = document.getElementById('items-panel');
            const detailsPanel = document.getElementById('details-panel');
            const helpPanel = document.getElementById('help-panel');
            const settingsPanel = document.getElementById('settings-panel');
            const aiAssistantPanel = document.getElementById('ai-assistant-panel');

            // Hide all special panels first
            helpPanel.style.display = 'none';
            settingsPanel.style.display = 'none';
            aiAssistantPanel.style.display = 'none';

            if (section === 'settings') {
                addBtn.style.display = 'none';
                importJobBtn.style.display = 'none';
                importResumeBtn.style.display = 'none';
                itemsPanel.style.display = 'none';
                detailsPanel.style.display = 'none';
                settingsPanel.style.display = 'block';
            } else if (section === 'ai-assistant') {
                addBtn.style.display = 'none';
                importJobBtn.style.display = 'none';
                importResumeBtn.style.display = 'none';
                itemsPanel.style.display = 'none';
                detailsPanel.style.display = 'none';
                aiAssistantPanel.style.display = 'block';
            } else if (section === 'help') {
                addBtn.style.display = 'none';
                importJobBtn.style.display = 'none';
                importResumeBtn.style.display = 'none';
                itemsPanel.style.display = 'none';
                detailsPanel.style.display = 'none';
                helpPanel.style.display = 'block';
            } else if (section === 'ai') {
                addBtn.style.display = 'none';
                importJobBtn.style.display = 'none';
                importResumeBtn.style.display = 'none';
                itemsPanel.style.display = '';
                detailsPanel.style.display = '';
                renderItemsList();
                showEmptyState();
            } else if (section === 'jobs') {
                addBtn.style.display = 'flex';
                importJobBtn.style.display = 'flex';
                importResumeBtn.style.display = 'none';
                itemsPanel.style.display = '';
                detailsPanel.style.display = '';
                renderItemsList();
                showEmptyState();
            } else if (section === 'resumes') {
                addBtn.style.display = 'flex';
                importJobBtn.style.display = 'none';
                importResumeBtn.style.display = 'flex';
                itemsPanel.style.display = '';
                detailsPanel.style.display = '';
                renderItemsList();
                showEmptyState();
            } else {
                addBtn.style.display = 'flex';
                importJobBtn.style.display = 'none';
                importResumeBtn.style.display = 'none';
                itemsPanel.style.display = '';
                detailsPanel.style.display = '';
                renderItemsList();
                showEmptyState();
            }
        }

        // Render items list
        function renderItemsList() {
            const container = document.getElementById('items-list');
            const items = data[currentSection] || [];

            container.innerHTML = '';

            if (items.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #7f8c8d;">
                        <i class="fas fa-inbox" style="font-size: 24px; margin-bottom: 10px; opacity: 0.5;"></i>
                        <div>No ${currentSection} yet</div>
                    </div>
                `;
                return;
            }

            items.forEach(item => {
                const card = createItemCard(item);
                container.appendChild(card);
            });
        }

        // Create item card for list
        function createItemCard(item) {
            const card = document.createElement('div');
            card.className = 'item-card';
            card.dataset.itemId = item.id;

            let title, subtitle, meta, status = '';

            switch (currentSection) {
                case 'jobs':
                    title = item.position || 'Untitled Position';
                    subtitle = item.company || 'Unknown Company';
                    meta = item.location || 'No location';
                    if (item.status) {
                        status = `<span class="status-badge status-${item.status}">${item.status}</span>`;
                    }
                    break;
                case 'resumes':
                    title = item.name || 'Untitled Resume';
                    subtitle = item.dateModified ? `Modified: ${new Date(item.dateModified).toLocaleDateString()}` : '';
                    meta = item.dateCreated ? `Created: ${new Date(item.dateCreated).toLocaleDateString()}` : '';
                    break;
                case 'letters':
                    title = item.name || 'Untitled Letter';
                    subtitle = item.type ? item.type.replace('_', ' ').toUpperCase() : 'Letter';
                    meta = item.dateCreated ? new Date(item.dateCreated).toLocaleDateString() : '';
                    break;
                case 'ai':
                    title = item.type || 'AI Interaction';
                    subtitle = item.service || 'Unknown Service';
                    meta = item.timestamp ? new Date(item.timestamp).toLocaleDateString() : '';
                    break;
            }

            card.innerHTML = `
                <div class="item-title">${escapeHtml(title)}</div>
                <div class="item-subtitle">${escapeHtml(subtitle)}</div>
                <div class="item-meta">
                    <span>${escapeHtml(meta)}</span>
                    ${status}
                </div>
            `;

            card.addEventListener('click', () => {
                selectItem(item);
            });

            return card;
        }

        // Select an item
        function selectItem(item) {
            currentItem = item;

            // Update selected state
            document.querySelectorAll('.item-card').forEach(card => {
                card.classList.remove('active');
            });
            document.querySelector(`[data-item-id="${item.id}"]`).classList.add('active');

            // Sync with global store
            if (currentSection === 'jobs') {
                setState({ currentJob: item }, 'jobs-html-job-selection');
            } else if (currentSection === 'resumes') {
                setState({ currentResume: item }, 'jobs-html-resume-selection');
            }

            renderItemDetails(item);
        }

        // Show empty state
        function showEmptyState() {
            const content = document.getElementById('details-content');
            const icons = {
                jobs: 'briefcase',
                resumes: 'file-alt',
                letters: 'envelope',
                ai: 'robot'
            };

            const messages = {
                jobs: 'Select a job to view details',
                resumes: 'Select a resume to view details', 
                letters: 'Select a letter to view details',
                ai: 'Select an AI interaction to view details'
            };

            content.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-${icons[currentSection]}"></i>
                    <h3>${messages[currentSection]}</h3>
                    <p>Choose an item from the list to view and edit its information</p>
                </div>
            `;
        }

        // Render item details
        function renderItemDetails(item) {
            const content = document.getElementById('details-content');
            const schema = schemas[currentSection];
            
            let html = '<div class="form-container">';
            
            Object.entries(schema).forEach(([key, field]) => {
                if (field.type === 'hidden') return;
                
                let value = item[key] || '';
                const readonly = field.readonly ? 'readonly' : '';
                const required = field.required ? 'required' : '';
                // Format for datetime-local
                if (field.type === 'datetime-local') {
                    value = formatDateForInput(value);
                }
                
                html += `<div class="form-group">`;
                html += `<label class="form-label">${escapeHtml(field.label)}</label>`;
                
                if (field.type === 'textarea') {
                    const rows = field.rows || 3;
                    html += `<textarea class="form-input form-textarea" rows="${rows}" ${readonly} ${required}>${escapeHtml(value)}</textarea>`;
                } else if (field.type === 'resume-editor') {
                    html += `
                        <div class="resume-content-container">
                            <div class="resume-tabs">
                                <button type="button" class="tab-btn active" data-tab="preview">Preview</button>
                                <button type="button" class="tab-btn" data-tab="edit">Edit</button>
                            </div>
                            <div class="tab-content">
                                <div class="tab-panel active" id="preview-tab">
                                    <div class="resume-viewer-controls">
                                        <label>Template: 
                                            <select id="template-selector">
                                                <option value="basic">Basic</option>
                                                <option value="modern">Modern</option>
                                                <option value="compact">Compact</option>
                                                <option value="elegant">Elegant</option>
                                            </select>
                                        </label>
                                    </div>
                                    <resume-viewer id="resume-viewer-details" template="basic"></resume-viewer>
                                </div>
                                <div class="tab-panel" id="edit-tab">
                                    <resume-editor id="resume-editor-details"></resume-editor>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (field.type === 'select') {
                    html += `<select class="form-input" ${readonly} ${required}>`;
                    if (typeof field.options === 'function') {
                        field.options().forEach(opt => {
                            const selected = value === opt.value ? 'selected' : '';
                            html += `<option value="${escapeHtml(opt.value)}" ${selected}>${escapeHtml(opt.label)}</option>`;
                        });
                    } else {
                        field.options.forEach(opt => {
                            const selected = value === opt ? 'selected' : '';
                            html += `<option value="${escapeHtml(opt)}" ${selected}>${escapeHtml(opt)}</option>`;
                        });
                    }
                    html += `</select>`;
                } else if (field.type === 'datetime-local') {
                    html += `<input type="datetime-local" class="form-input" value="${escapeHtml(value)}" ${readonly} ${required}>`;
                } else {
                    html += `<input type="${field.type}" class="form-input" value="${escapeHtml(value)}" ${readonly} ${required}>`;
                }
                
                html += `</div>`;
            });
            
            if (currentSection !== 'ai') {
                html += `
                    <div class="form-actions">
                        <button type="button" class="btn btn-primary" onclick="editCurrentItem()">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        ${currentSection === 'resumes' ? `
                            <button type="button" class="btn btn-success" onclick="generateResumePDF()" style="background: #e67e22;">
                                <i class="fas fa-file-pdf"></i> Generate PDF
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="printResume()" style="background: #34495e;">
                                <i class="fas fa-print"></i> Print
                            </button>
                        ` : ''}
                        ${currentSection === 'letters' ? `
                            <button type="button" class="btn btn-success" onclick="generateLetterPDF()" style="background: #e67e22;">
                                <i class="fas fa-file-pdf"></i> Generate PDF
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="printLetter()" style="background: #34495e;">
                                <i class="fas fa-print"></i> Print
                            </button>
                        ` : ''}
                        ${currentSection === 'jobs' ? `
                            <button type="button" class="btn btn-success" onclick="generateAIContent()" style="background: #27ae60;">
                                <i class="fas fa-robot"></i> AI Tailor Resume & Letter
                            </button>
                        ` : ''}
                        <button type="button" class="btn" onclick="deleteCurrentItem()" style="background: #e74c3c; color: white;">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                `;
            }
            
            html += '</div>';
            content.innerHTML = html;
            
            // Initialize resume editor and viewer if present
            if (currentSection === 'resumes' && item.content) {
                setTimeout(() => {
                    const resumeEditor = document.querySelector('#resume-editor-details');
                    const resumeViewer = document.querySelector('#resume-viewer-details');
                    const templateSelector = document.querySelector('#template-selector');
                    
                    try {
                        const resumeData = typeof item.content === 'string' ? JSON.parse(item.content) : item.content;
                        
                        if (resumeEditor) {
                            resumeEditor.setResumeData(resumeData);
                        }
                        
                        if (resumeViewer) {
                            resumeViewer.setResumeData(resumeData);
                        }
                        
                        // Handle template selector
                        if (templateSelector) {
                            // Remove any existing event listeners first
                            templateSelector.removeEventListener('change', window.handleTemplateChangeDetails);
                            
                            // Create a new event handler function
                            window.handleTemplateChangeDetails = function(e) {
                                console.log('Switching template to:', e.target.value);
                                if (resumeViewer) {
                                    resumeViewer.setTemplate(e.target.value);
                                }
                            };
                            
                            templateSelector.addEventListener('change', window.handleTemplateChangeDetails);
                        }
                        
                        // Handle tab switching
                        const tabButtons = document.querySelectorAll('.tab-btn');
                        const tabPanels = document.querySelectorAll('.tab-panel');
                        
                        tabButtons.forEach(btn => {
                            btn.addEventListener('click', () => {
                                const targetTab = btn.dataset.tab;
                                
                                // Update active tab button
                                tabButtons.forEach(b => b.classList.remove('active'));
                                btn.classList.add('active');
                                
                                // Update active tab panel
                                tabPanels.forEach(panel => {
                                    panel.classList.remove('active');
                                    if (panel.id === targetTab + '-tab') {
                                        panel.classList.add('active');
                                    }
                                });
                            });
                        });
                        
                    } catch (e) {
                        console.error('Error loading resume data:', e);
                    }
                }, 100);
            }
        }

        // Add new item
        function addNewItem() {
            const newItem = { id: generateId() };
            
            // Set default values based on section
            if (currentSection === 'jobs') {
                newItem.status = 'saved';
                newItem.dateCreated = new Date().toISOString();
            } else if (currentSection === 'resumes') {
                newItem.dateCreated = new Date().toISOString();
                newItem.dateModified = new Date().toISOString();
                newItem.content = '{}';
            } else if (currentSection === 'letters') {
                newItem.type = 'cover_letter';
                newItem.dateCreated = new Date().toISOString();
            }
            
            openFormModal('Add ' + currentSection.slice(0, -1), newItem, true);
        }

        // Edit current item
        window.editCurrentItem = function() {
            if (!currentItem) return;
            openFormModal('Edit ' + currentSection.slice(0, -1), currentItem, false);
        };

        // Delete current item
        window.deleteCurrentItem = function() {
            if (!currentItem) return;
            
            const itemName = currentItem.name || currentItem.position || currentItem.company || 'this item';
            if (confirm(`Are you sure you want to delete ${itemName}?`)) {
                const index = data[currentSection].findIndex(item => item.id === currentItem.id);
                if (index > -1) {
                    data[currentSection].splice(index, 1);
                    saveData();
                    renderItemsList();
                    showEmptyState();
                }
            }
        };

        // Open form modal
        function openFormModal(title, item, isNew) {
            document.getElementById('form-modal-title').textContent = title;
            const form = document.getElementById('generic-form');
            const schema = schemas[currentSection];
            
            form.innerHTML = '';
            form.dataset.itemId = item.id;
            form.dataset.isNew = isNew;
            
            Object.entries(schema).forEach(([key, field]) => {
                let value = item[key] || '';
                
                const group = document.createElement('div');
                group.className = 'form-group';
                
                if (field.type === 'hidden') {
                    group.innerHTML = `<input type="hidden" name="${key}" value="${escapeHtml(value)}">`;
                } else {
                    const required = field.required ? 'required' : '';
                    const readonly = field.readonly ? 'readonly' : '';
                    // Format for datetime-local
                    if (field.type === 'datetime-local') {
                        value = formatDateForInput(value);
                    }
                    group.innerHTML = `
                        <label class="form-label">${escapeHtml(field.label)}</label>
                    `;
                    
                    if (field.type === 'textarea') {
                        const rows = field.rows || 3;
                        group.innerHTML += `<textarea class="form-input form-textarea" name="${key}" rows="${rows}" ${required} ${readonly}>${escapeHtml(value)}</textarea>`;
                    } else if (field.type === 'resume-editor') {
                        group.innerHTML += `
                            <div class="resume-content-container">
                                <div class="resume-tabs">
                                    <button type="button" class="tab-btn active" data-tab="preview">Preview</button>
                                    <button type="button" class="tab-btn" data-tab="edit">Edit</button>
                                </div>
                                <div class="tab-content">
                                    <div class="tab-panel active" id="preview-tab-modal">
                                        <div class="resume-viewer-controls">
                                            <label>Template: 
                                                <select id="template-selector-modal">
                                                    <option value="basic">Basic</option>
                                                    <option value="modern">Modern</option>
                                                    <option value="compact">Compact</option>
                                                    <option value="elegant">Elegant</option>
                                                </select>
                                            </label>
                                        </div>
                                        <resume-viewer id="resume-viewer-modal" template="basic"></resume-viewer>
                                    </div>
                                    <div class="tab-panel" id="edit-tab-modal">
                                        <resume-editor id="resume-editor-modal"></resume-editor>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else if (field.type === 'select') {
                        let optionsHtml = '';
                        if (typeof field.options === 'function') {
                            field.options().forEach(opt => {
                                const selected = value === opt.value ? 'selected' : '';
                                optionsHtml += `<option value="${escapeHtml(opt.value)}" ${selected}>${escapeHtml(opt.label)}</option>`;
                            });
                        } else {
                            field.options.forEach(opt => {
                                const selected = value === opt ? 'selected' : '';
                                optionsHtml += `<option value="${escapeHtml(opt)}" ${selected}>${escapeHtml(opt)}</option>`;
                            });
                        }
                        group.innerHTML += `<select class="form-input" name="${key}" ${required} ${readonly}>${optionsHtml}</select>`;
                    } else if (field.type === 'datetime-local') {
                        group.innerHTML += `<input type="datetime-local" class="form-input" name="${key}" value="${escapeHtml(value)}" ${required} ${readonly}>`;
                    } else {
                        group.innerHTML += `<input type="${field.type}" class="form-input" name="${key}" value="${escapeHtml(value)}" ${required} ${readonly}>`;
                    }
                }
                
                form.appendChild(group);
            });
            
            document.getElementById('form-modal').classList.remove('hidden');
            
            // Initialize resume editor and viewer if present
            if (currentSection === 'resumes' && item.content) {
                setTimeout(() => {
                    const resumeEditor = document.querySelector('#resume-editor-modal');
                    const resumeViewer = document.querySelector('#resume-viewer-modal');
                    const templateSelector = document.querySelector('#template-selector-modal');
                    
                    try {
                        const resumeData = typeof item.content === 'string' ? JSON.parse(item.content) : item.content;
                        
                        if (resumeEditor) {
                            resumeEditor.setResumeData(resumeData);
                        }
                        
                        if (resumeViewer) {
                            resumeViewer.setResumeData(resumeData);
                        }
                        
                        // Handle template selector
                        if (templateSelector) {
                            // Remove any existing event listeners first
                            templateSelector.removeEventListener('change', window.handleTemplateChangeModal);
                            
                            // Create a new event handler function
                            window.handleTemplateChangeModal = function(e) {
                                console.log('Switching modal template to:', e.target.value);
                                if (resumeViewer) {
                                    resumeViewer.setTemplate(e.target.value);
                                }
                            };
                            
                            templateSelector.addEventListener('change', window.handleTemplateChangeModal);
                        }
                        
                        // Handle tab switching in modal
                        const tabButtons = document.querySelectorAll('.modal .tab-btn');
                        const tabPanels = document.querySelectorAll('.modal .tab-panel');
                        
                        tabButtons.forEach(btn => {
                            btn.addEventListener('click', () => {
                                const targetTab = btn.dataset.tab;
                                
                                // Update active tab button
                                tabButtons.forEach(b => b.classList.remove('active'));
                                btn.classList.add('active');
                                
                                // Update active tab panel
                                tabPanels.forEach(panel => {
                                    panel.classList.remove('active');
                                    if (panel.id === targetTab + '-tab-modal') {
                                        panel.classList.add('active');
                                    }
                                });
                            });
                        });
                        
                    } catch (e) {
                        console.error('Error loading resume data into modal:', e);
                    }
                }, 100);
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('form-modal').classList.add('hidden');
        }


        // Settings functions
        function openSettings() {
            switchSection('settings');
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        function saveSettings() {
            const apiKey = document.getElementById('api-key').value;
            const apiType = document.getElementById('api-type').value;
            const useDirectApi = document.getElementById('use-direct-api').checked;
            
            localStorage.setItem('api_key', apiKey);
            localStorage.setItem('api_type', apiType);
            localStorage.setItem('use_direct_api', useDirectApi);
            
            closeSettings();
            
            // Show success message
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #27ae60;
                color: white;
                padding: 10px 20px;
                border-radius: 5px;
                z-index: 1001;
            `;
            toast.textContent = 'Settings saved successfully';
            document.body.appendChild(toast);
            
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 3000);
        }

        // AI Generation Functions
        window.generateAIContent = function() {
            if (!currentItem || currentSection !== 'jobs') {
                alert('Please select a job first.');
                return;
            }

            // Check API configuration
            const apiKey = localStorage.getItem('api_key');
            if (!apiKey) {
                document.getElementById('ai-api-warning').classList.remove('hidden');
                document.getElementById('ai-generate').disabled = true;
            } else {
                document.getElementById('ai-api-warning').classList.add('hidden');
                document.getElementById('ai-generate').disabled = false;
            }

            // Populate job details
            populateJobDetails();
            
            // Populate resume options
            populateResumeOptions();
            
            // Show AI modal
            document.getElementById('ai-modal').classList.remove('hidden');
        };

        function populateJobDetails() {
            const job = currentItem;
            const container = document.getElementById('ai-job-details');
            
            container.innerHTML = `
                <div style="margin-bottom: 10px;">
                    <strong>${escapeHtml(job.position || 'Unknown Position')}</strong> at 
                    <strong>${escapeHtml(job.company || 'Unknown Company')}</strong>
                </div>
                ${job.location ? `<div style="margin-bottom: 10px;"><i class="fas fa-map-marker-alt"></i> ${escapeHtml(job.location)}</div>` : ''}
                ${job.description ? `
                    <div style="margin-bottom: 10px;">
                        <strong>Description:</strong><br>
                        <div style="max-height: 100px; overflow-y: auto; padding: 5px; background: white; border: 1px solid #ddd; border-radius: 3px;">
                            ${escapeHtml(job.description)}
                        </div>
                    </div>
                ` : ''}
                ${job.jobDetails ? `
                    <div>
                        <strong>Job Details:</strong><br>
                        <div style="max-height: 150px; overflow-y: auto; padding: 5px; background: white; border: 1px solid #ddd; border-radius: 3px;">
                            ${escapeHtml(job.jobDetails)}
                        </div>
                    </div>
                ` : ''}
            `;
        }

        function populateResumeOptions() {
            const select = document.getElementById('ai-base-resume');
            select.innerHTML = '<option value="">Choose a resume to tailor...</option>';
            
            data.resumes.forEach(resume => {
                const option = document.createElement('option');
                option.value = resume.id;
                option.textContent = resume.name || 'Untitled Resume';
                select.appendChild(option);
            });
        }

        function closeAIModal() {
            document.getElementById('ai-modal').classList.add('hidden');
            document.getElementById('ai-progress').classList.add('hidden');
            document.getElementById('ai-custom-instructions').value = '';
            document.getElementById('ai-base-resume').value = '';
        }

        async function processAIGeneration() {
            const job = currentItem;
            const baseResumeId = document.getElementById('ai-base-resume').value;
            const customInstructions = document.getElementById('ai-custom-instructions').value;
            const generateCoverLetter = document.getElementById('ai-generate-cover-letter').checked;

            if (!baseResumeId) {
                alert('Please select a base resume to tailor.');
                return;
            }

            // Find the base resume
            const baseResume = data.resumes.find(r => r.id === baseResumeId);
            if (!baseResume) {
                alert('Selected resume not found.');
                return;
            }

            // Get API configuration
            const apiKey = localStorage.getItem('api_key');
            const apiType = localStorage.getItem('api_type') || 'claude';
            const useDirectApi = localStorage.getItem('use_direct_api') === 'true';

            if (!apiKey) {
                alert('Please configure your API key in Settings.');
                return;
            }

            // Show progress
            showAIProgress('Analyzing job requirements and tailoring resume...');

            try {
                let result;
                const jobDescription = `${job.description || ''}\n\n${job.jobDetails || ''}`.trim();
                
                if (useDirectApi) {
                    // Direct API calls
                    if (apiType === 'claude') {
                        result = await callClaudeDirectly(baseResume.content, jobDescription, apiKey, customInstructions);
                    } else if (apiType === 'chatgpt') {
                        result = await callOpenAIDirectly(baseResume.content, jobDescription, apiKey, customInstructions);
                    } else {
                        throw new Error('Invalid API type selected');
                    }
                } else {
                    // Server API approach
                    result = await callServerAPI(baseResume.content, jobDescription, apiKey, apiType, customInstructions);
                }

                if (!result || !result.resume) {
                    throw new Error('Invalid response format from AI service');
                }

                // Process results
                await processAIResults(result, job, baseResume, generateCoverLetter);

            } catch (error) {
                console.error('Error in AI generation:', error);
                alert(`Error: ${error.message}`);
            } finally {
                closeAIModal();
            }
        }

        function showAIProgress(message) {
            document.getElementById('ai-progress-text').textContent = message;
            document.getElementById('ai-progress').classList.remove('hidden');
            document.getElementById('ai-generate').disabled = true;
        }

        async function processAIResults(result, job, baseResume, generateCoverLetter) {
            const timestamp = new Date().toISOString();

            // Create tailored resume
            const tailoredResume = {
                id: generateId(),
                name: `${job.position} at ${job.company} - ${new Date().toLocaleDateString()}`,
                content: result.resume,
                dateCreated: timestamp,
                dateModified: timestamp
            };

            // Add to resumes
            data.resumes.push(tailoredResume);

            // Update job to associate with tailored resume
            const jobIndex = data.jobs.findIndex(j => j.id === job.id);
            if (jobIndex > -1) {
                data.jobs[jobIndex].resumeId = tailoredResume.id;
            }

            // Create cover letter if requested
            let coverLetter = null;
            if (generateCoverLetter && result.coverLetter) {
                coverLetter = {
                    id: generateId(),
                    name: `Cover Letter - ${job.position} at ${job.company}`,
                    type: 'cover_letter',
                    content: result.coverLetter,
                    jobId: job.id,
                    dateCreated: timestamp
                };
                data.letters.push(coverLetter);
            }

            // Log AI interaction
            const aiLog = {
                id: generateId(),
                type: 'resume_tailoring',
                service: localStorage.getItem('api_type') || 'claude',
                prompt: `Tailor resume for ${job.position} at ${job.company}`,
                response: 'Resume and cover letter generated successfully',
                timestamp: timestamp,
                jobId: job.id,
                resumeId: tailoredResume.id,
                coverLetterId: coverLetter?.id || null
            };
            data.ai.push(aiLog);

            // Save all data
            saveData();

            // Refresh UI
            renderItemsList();
            if (currentItem && currentItem.id === job.id) {
                selectItem(data.jobs.find(j => j.id === job.id)); // Refresh the current job display
            }

            // Show success message
            let message = `✅ Successfully created tailored resume: "${tailoredResume.name}"`;
            if (coverLetter) {
                message += `\n✅ Generated cover letter: "${coverLetter.name}"`;
            }
            alert(message);
        }

        // Direct Claude API call (adapted from your existing implementation)
        async function callClaudeDirectly(resumeContent, jobDescription, apiKey, customInstructions = '') {
            console.log('Calling Claude API directly from browser');
            
            const resumeStr = typeof resumeContent === 'string' ? resumeContent : JSON.stringify(resumeContent, null, 2);
            
            const customPrompt = customInstructions ? `\n\nCustom instructions: ${customInstructions}` : '';
            
            const prompt = `
You must create a valid, properly escaped JSON object containing a tailored resume and cover letter for this job description:
\`\`\`
${jobDescription.substring(0, 2000)}${jobDescription.length > 2000 ? '...' : ''}
\`\`\`

Based on this resume:
\`\`\`json
${resumeStr.substring(0, 6000)}${resumeStr.length > 6000 ? '...' : ''}
\`\`\`
${customPrompt}

IMPORTANT:
1. Your response MUST be ONLY a valid JSON object with NO explanation or additional text
2. The JSON must be properly escaped - all quotes within strings must be escaped, no unescaped newlines in strings
3. Use the EXACT structure shown below, with these fields:
{
  "resume": {/* Tailored resume object following JSON Resume schema */},
  "coverLetter": "Professional cover letter text",
  "jobDescription": "Original job description"
}
4. Make sure all strings are properly quoted and all JSON syntax is correct
5. Do not include any markdown formatting like \`\`\`json or \`\`\` in your response
6. CRITICAL: Include ALL sections from the original resume. Tailor content but preserve structure.
7. For the cover letter, write a professional, personalized letter that highlights relevant experience.`;

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-3-5-sonnet-20241022',
                        max_tokens: 4000,
                        temperature: 0.3,
                        messages: [
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        system: "You are an expert resume writer and career coach. Create valid, properly escaped JSON responses for resume tailoring and cover letter generation."
                    })
                });

                if (!response.ok) {
                    throw new Error(`Claude API error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                const assistantMessage = data.content[0].text;

                // Parse the JSON response
                const jsonMatch = assistantMessage.match(/{[\s\S]*}/);
                if (!jsonMatch) {
                    throw new Error('Could not extract JSON from Claude response');
                }

                return JSON.parse(jsonMatch[0]);
                
            } catch (error) {
                console.error('Error calling Claude API directly:', error);
                throw new Error(`Claude API error: ${error.message}`);
            }
        }

        // Direct OpenAI API call (adapted from your existing implementation)
        async function callOpenAIDirectly(resumeContent, jobDescription, apiKey, customInstructions = '') {
            console.log('Calling OpenAI API directly from browser');
            
            const resumeStr = typeof resumeContent === 'string' ? resumeContent : JSON.stringify(resumeContent, null, 2);
            const customPrompt = customInstructions ? `\n\nCustom instructions: ${customInstructions}` : '';
            
            const systemMessage = "You are an expert resume writer and career coach. You specialize in tailoring resumes and writing cover letters. " +
                                 "Respond ONLY with a complete, syntactically valid JSON object. No markdown, no code blocks, no explanations. " +
                                 "Ensure all quotes in strings are escaped properly and there are no unescaped newlines in string values.";
            
            const userMessage = `Create a tailored resume and cover letter for this job description:
\`\`\`
${jobDescription.substring(0, 2000)}${jobDescription.length > 2000 ? '...' : ''}
\`\`\`

Based on this original resume:
\`\`\`json
${resumeStr.substring(0, 6000)}${resumeStr.length > 6000 ? '...' : ''}
\`\`\`
${customPrompt}

REQUIREMENTS:
1. Return ONLY a valid JSON object with NO explanations or text outside the JSON
2. Use this exact structure:
{
  "resume": {/* Tailored resume object */},
  "coverLetter": "Cover letter text",
  "jobDescription": "Original job description"
}
3. Include ALL sections from the original resume, tailored for the job
4. Write a professional, personalized cover letter`;

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        messages: [
                            {
                                role: 'system',
                                content: systemMessage
                            },
                            {
                                role: 'user',
                                content: userMessage
                            }
                        ],
                        temperature: 0.3
                    })
                });

                if (!response.ok) {
                    throw new Error(`OpenAI API error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                const messageContent = data.choices[0].message.content;
                
                // Clean and parse the JSON
                const cleanedContent = messageContent.trim().replace(/^```json\n|^```\n|```$/g, '');
                return JSON.parse(cleanedContent);
                
            } catch (error) {
                console.error('Error calling OpenAI API directly:', error);
                throw new Error(`OpenAI API error: ${error.message}`);
            }
        }

        // Server API call
        async function callServerAPI(resumeContent, jobDescription, apiKey, apiType, customInstructions = '') {
            const requestData = {
                resume: resumeContent,
                jobDescription: jobDescription,
                apiKey: apiKey,
                apiType: apiType,
                customInstructions: customInstructions
            };
            
            const endpoint = `http://${window.location.hostname}:3000/api/tailor-resume`;
            console.log(`Sending request to server: ${endpoint}`);
            
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to tailor resume');
            }
            
            return await response.json();
        }

        // Import Job Functions
        function openImportJobModal() {
            // Check API configuration
            const apiKey = localStorage.getItem('api_key');
            if (!apiKey) {
                document.getElementById('import-api-warning').classList.remove('hidden');
                document.getElementById('import-job-submit').disabled = true;
            } else {
                document.getElementById('import-api-warning').classList.add('hidden');
                document.getElementById('import-job-submit').disabled = false;
            }
            
            document.getElementById('import-job-modal').classList.remove('hidden');
        }

        function closeImportJobModal() {
            document.getElementById('import-job-modal').classList.add('hidden');
            document.getElementById('import-progress').classList.add('hidden');
            document.getElementById('import-job-url').value = '';
            document.getElementById('import-job-description').value = '';
            document.getElementById('import-custom-instructions').value = '';
            document.getElementById('import-method-url').checked = true;
            toggleImportMethod();
        }

        function toggleImportMethod() {
            const urlMethod = document.getElementById('import-method-url').checked;
            const urlSection = document.getElementById('import-url-section');
            const descSection = document.getElementById('import-description-section');
            
            if (urlMethod) {
                urlSection.classList.remove('hidden');
                descSection.classList.add('hidden');
            } else {
                urlSection.classList.add('hidden');
                descSection.classList.remove('hidden');
            }
        }

        async function processJobImport() {
            const urlMethod = document.getElementById('import-method-url').checked;
            const jobUrl = document.getElementById('import-job-url').value.trim();
            const jobDescription = document.getElementById('import-job-description').value.trim();
            const customInstructions = document.getElementById('import-custom-instructions').value.trim();

            if (urlMethod && !jobUrl) {
                alert('Please enter a job URL');
                return;
            }
            if (!urlMethod && !jobDescription) {
                alert('Please paste the job description');
                return;
            }

            const apiKey = localStorage.getItem('api_key');
            const apiType = localStorage.getItem('api_type') || 'claude';
            const useDirectApi = localStorage.getItem('use_direct_api') === 'true';

            if (!apiKey) {
                alert('Please configure your API key in Settings.');
                return;
            }

            // Show progress
            showImportProgress('Analyzing job content and extracting information...');

            try {
                let content = jobDescription;
                
                if (urlMethod) {
                    // For URL method, we'll send the URL to AI to extract content
                    content = `Please fetch and analyze the job posting at this URL: ${jobUrl}`;
                }

                let result;
                if (useDirectApi) {
                    if (apiType === 'claude') {
                        result = await extractJobDataWithClaude(content, customInstructions, apiKey, urlMethod);
                    } else if (apiType === 'chatgpt') {
                        result = await extractJobDataWithOpenAI(content, customInstructions, apiKey, urlMethod);
                    } else {
                        throw new Error('Invalid API type selected');
                    }
                } else {
                    // Server API approach
                    result = await extractJobDataWithServer(content, customInstructions, apiKey, apiType, urlMethod);
                }

                if (!result) {
                    throw new Error('Invalid response from AI service');
                }

                // Process the extracted job data
                await processImportedJobData(result, urlMethod ? jobUrl : null);

            } catch (error) {
                console.error('Error importing job:', error);
                alert(`Error: ${error.message}`);
            } finally {
                closeImportJobModal();
            }
        }

        function showImportProgress(message) {
            document.getElementById('import-progress-text').textContent = message;
            document.getElementById('import-progress').classList.remove('hidden');
            document.getElementById('import-job-submit').disabled = true;
        }

        async function processImportedJobData(jobData, sourceUrl = null) {
            const timestamp = new Date().toISOString();

            // Create new job with extracted data
            const newJob = {
                id: generateId(),
                company: jobData.company || '',
                position: jobData.position || jobData.title || '',
                status: 'saved',
                datePosted: jobData.datePosted || '',
                dateApplied: null,
                description: jobData.shortDescription || jobData.description || '',
                jobDetails: jobData.jobDetails || jobData.fullDescription || jobData.description || '',
                location: jobData.location || '',
                contactName: jobData.contactName || '',
                contactEmail: jobData.contactEmail || '',
                contactPhone: jobData.contactPhone || '',
                url: sourceUrl || jobData.url || '',
                notes: jobData.notes || '',
                dateCreated: timestamp,
                dateUpdated: timestamp
            };

            // Add to jobs
            data.jobs.push(newJob);

            // Log AI interaction
            const aiLog = {
                id: generateId(),
                type: 'job_import',
                service: localStorage.getItem('api_type') || 'claude',
                prompt: sourceUrl ? `Import job from URL: ${sourceUrl}` : 'Import job from description',
                response: `Imported job: ${newJob.position} at ${newJob.company}`,
                timestamp: timestamp,
                jobId: newJob.id
            };
            data.ai.push(aiLog);

            // Save data
            saveData();

            // Refresh UI
            renderItemsList();
            selectItem(newJob);

            // Show success message
            alert(`✅ Successfully imported job: "${newJob.position}" at "${newJob.company}"`);
        }

        // Extract job data using Claude
        async function extractJobDataWithClaude(content, customInstructions, apiKey, isUrl = false) {
            console.log('Extracting job data with Claude');
            
            const customPrompt = customInstructions ? `\n\nCustom instructions: ${customInstructions}` : '';
            const urlNote = isUrl ? '\n\nNote: This is a URL - please fetch the content from this URL first, then extract the job information.' : '';
            
            const prompt = `
Extract job information from the following content and return it as a valid JSON object.

${urlNote}

Content:
\`\`\`
${content.substring(0, 3000)}${content.length > 3000 ? '...' : ''}
\`\`\`
${customPrompt}

IMPORTANT:
1. Your response MUST be ONLY a valid JSON object with NO explanation or additional text
2. Use this EXACT schema structure:
{
  "company": "Company name",
  "position": "Job title/position",
  "location": "Job location (city, state/country)",
  "shortDescription": "Brief 2-3 sentence summary",
  "jobDetails": "Full job description including responsibilities and requirements",
  "datePosted": "Date posted (YYYY-MM-DD format if available)",
  "contactName": "Contact person name if mentioned",
  "contactEmail": "Contact email if mentioned", 
  "contactPhone": "Contact phone if mentioned",
  "url": "Job posting URL if different from source",
  "notes": "Any additional relevant information"
}
3. Extract as much information as possible from the content
4. If information is not available, use empty string ""
5. Ensure all JSON syntax is correct with proper escaping`;

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-3-5-sonnet-20241022',
                        max_tokens: 2000,
                        temperature: 0.1,
                        messages: [
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        system: "You are an expert at extracting structured job information from unstructured text. Always return valid, properly escaped JSON."
                    })
                });

                if (!response.ok) {
                    throw new Error(`Claude API error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                const assistantMessage = data.content[0].text;

                // Parse the JSON response
                const jsonMatch = assistantMessage.match(/{[\s\S]*}/);
                if (!jsonMatch) {
                    throw new Error('Could not extract JSON from Claude response');
                }

                return JSON.parse(jsonMatch[0]);
                
            } catch (error) {
                console.error('Error calling Claude API for job extraction:', error);
                throw new Error(`Claude API error: ${error.message}`);
            }
        }

        // Extract job data using OpenAI
        async function extractJobDataWithOpenAI(content, customInstructions, apiKey, isUrl = false) {
            console.log('Extracting job data with OpenAI');
            
            const customPrompt = customInstructions ? `\n\nCustom instructions: ${customInstructions}` : '';
            const urlNote = isUrl ? '\n\nNote: This is a URL - please fetch the content from this URL first, then extract the job information.' : '';
            
            const systemMessage = "You are an expert at extracting structured job information from unstructured text. " +
                                 "Respond ONLY with a complete, syntactically valid JSON object. No markdown, no code blocks, no explanations.";
            
            const userMessage = `Extract job information from the following content and return it as a valid JSON object.

${urlNote}

Content:
\`\`\`
${content.substring(0, 3000)}${content.length > 3000 ? '...' : ''}
\`\`\`
${customPrompt}

Use this EXACT schema:
{
  "company": "Company name",
  "position": "Job title/position", 
  "location": "Job location",
  "shortDescription": "Brief summary",
  "jobDetails": "Full description",
  "datePosted": "YYYY-MM-DD if available",
  "contactName": "Contact name if mentioned",
  "contactEmail": "Contact email if mentioned",
  "contactPhone": "Contact phone if mentioned", 
  "url": "Job URL if different",
  "notes": "Additional info"
}

Return ONLY the JSON object with no additional text.`;

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        messages: [
                            {
                                role: 'system',
                                content: systemMessage
                            },
                            {
                                role: 'user',
                                content: userMessage
                            }
                        ],
                        temperature: 0.1
                    })
                });

                if (!response.ok) {
                    throw new Error(`OpenAI API error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                const messageContent = data.choices[0].message.content;
                
                // Clean and parse the JSON
                const cleanedContent = messageContent.trim().replace(/^```json\n|^```\n|```$/g, '');
                return JSON.parse(cleanedContent);
                
            } catch (error) {
                console.error('Error calling OpenAI API for job extraction:', error);
                throw new Error(`OpenAI API error: ${error.message}`);
            }
        }

        // Extract job data using server API
        async function extractJobDataWithServer(content, customInstructions, apiKey, apiType, isUrl = false) {
            const requestData = {
                content: content,
                customInstructions: customInstructions,
                apiKey: apiKey,
                apiType: apiType,
                isUrl: isUrl
            };
            
            const endpoint = `http://${window.location.hostname}:3000/api/extract-job`;
            console.log(`Sending request to server: ${endpoint}`);
            
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to extract job data');
            }
            
            return await response.json();
        }

        // Import Resume Functions
        function openImportResumeModal() {
            document.getElementById('import-resume-modal').classList.remove('hidden');
        }

        function closeImportResumeModal() {
            document.getElementById('import-resume-modal').classList.add('hidden');
            document.getElementById('resume-json-input').value = '';
            document.getElementById('resume-url-input').value = '';
            document.getElementById('resume-name-input').value = '';
            document.getElementById('resume-import-method-paste').checked = true;
            toggleResumeImportMethod();
            // Reset file input
            const fileInput = document.getElementById('resume-file-input');
            if (fileInput) {
                fileInput.value = '';
            }
            document.getElementById('resume-file-name').classList.add('hidden');
        }

        function toggleResumeImportMethod() {
            const pasteMethod = document.getElementById('resume-import-method-paste').checked;
            const fileMethod = document.getElementById('resume-import-method-file').checked;
            const urlMethod = document.getElementById('resume-import-method-url').checked;
            
            const pasteSection = document.getElementById('resume-paste-section');
            const fileSection = document.getElementById('resume-file-section');
            const urlSection = document.getElementById('resume-url-section');
            
            // Hide all sections first
            pasteSection.classList.add('hidden');
            fileSection.classList.add('hidden');
            urlSection.classList.add('hidden');
            
            if (pasteMethod) {
                pasteSection.classList.remove('hidden');
            } else if (fileMethod) {
                fileSection.classList.remove('hidden');
                setupFileDragDrop();
            } else if (urlMethod) {
                urlSection.classList.remove('hidden');
            }
        }

        function setupFileDragDrop() {
            const dragDropArea = document.getElementById('resume-drag-drop-area');
            const fileInput = document.getElementById('resume-file-input');
            const fileNameDiv = document.getElementById('resume-file-name');

            if (dragDropArea && fileInput) {
                // Click to browse
                dragDropArea.addEventListener('click', () => {
                    fileInput.click();
                });

                // File selection
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files && e.target.files[0]) {
                        const file = e.target.files[0];
                        if (file.type === 'application/json' || file.name.endsWith('.json')) {
                            fileNameDiv.textContent = `Selected: ${file.name}`;
                            fileNameDiv.classList.remove('hidden');
                        } else {
                            alert('Please select a valid JSON file.');
                            e.target.value = '';
                        }
                    }
                });

                // Drag and drop
                dragDropArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dragDropArea.style.borderColor = '#007bff';
                    dragDropArea.style.backgroundColor = '#f8f9fa';
                });

                dragDropArea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    dragDropArea.style.borderColor = '#ddd';
                    dragDropArea.style.backgroundColor = 'transparent';
                });

                dragDropArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dragDropArea.style.borderColor = '#ddd';
                    dragDropArea.style.backgroundColor = 'transparent';
                    
                    const files = e.dataTransfer.files;
                    if (files && files[0]) {
                        const file = files[0];
                        if (file.type === 'application/json' || file.name.endsWith('.json')) {
                            fileInput.files = files;
                            fileNameDiv.textContent = `Selected: ${file.name}`;
                            fileNameDiv.classList.remove('hidden');
                        } else {
                            alert('Please drop a valid JSON file.');
                        }
                    }
                });
            }
        }

        async function processResumeImport() {
            const pasteMethod = document.getElementById('resume-import-method-paste').checked;
            const fileMethod = document.getElementById('resume-import-method-file').checked;
            const urlMethod = document.getElementById('resume-import-method-url').checked;
            
            const resumeName = document.getElementById('resume-name-input').value.trim();
            
            if (!resumeName) {
                alert('Please enter a name for the resume.');
                return;
            }

            let resumeData = null;

            try {
                if (pasteMethod) {
                    const jsonInput = document.getElementById('resume-json-input').value.trim();
                    if (!jsonInput) {
                        alert('Please paste resume JSON content.');
                        return;
                    }
                    resumeData = JSON.parse(jsonInput);
                } else if (fileMethod) {
                    const fileInput = document.getElementById('resume-file-input');
                    if (!fileInput.files || !fileInput.files[0]) {
                        alert('Please select a JSON file.');
                        return;
                    }
                    
                    const file = fileInput.files[0];
                    const fileContent = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.onerror = reject;
                        reader.readAsText(file);
                    });
                    
                    resumeData = JSON.parse(fileContent);
                } else if (urlMethod) {
                    const urlInput = document.getElementById('resume-url-input').value.trim();
                    if (!urlInput) {
                        alert('Please enter a URL.');
                        return;
                    }
                    
                    // Fetch JSON from URL
                    const response = await fetch(urlInput);
                    if (!response.ok) {
                        throw new Error(`Failed to fetch from URL: ${response.status} ${response.statusText}`);
                    }
                    
                    resumeData = await response.json();
                }

                // Validate basic resume structure
                if (!resumeData || typeof resumeData !== 'object') {
                    throw new Error('Invalid resume format - must be a JSON object.');
                }

                // Create new resume
                const timestamp = new Date().toISOString();
                const newResume = {
                    id: generateId(),
                    name: resumeName,
                    content: resumeData,
                    dateCreated: timestamp,
                    dateModified: timestamp
                };

                // Add to resumes
                data.resumes.push(newResume);
                saveData();

                // Refresh UI
                renderItemsList();
                selectItem(newResume);

                // Close modal
                closeImportResumeModal();

                // Show success message
                alert(`✅ Successfully imported resume: "${resumeName}"`);

            } catch (error) {
                console.error('Error importing resume:', error);
                alert(`Error importing resume: ${error.message}`);
            }
        }

        // Open resume editor modal for visual editing
        window.openResumeEditorModal = function(fieldKey) {
            // This would open a full-screen modal with the resume editor
            // For now, we'll show a message about the functionality
            alert('Visual resume editor integration - this would open a full resume editing interface. For now, please use the JSON textarea.');
        };

        // Save item with special handling for resume content
        function saveItemWithResumeData() {
            const form = document.getElementById('generic-form');
            const formData = new FormData(form);
            const itemData = {};
            
            for (const [key, value] of formData.entries()) {
                if (key === 'content' && currentSection === 'resumes') {
                    // Special handling for resume content - validate JSON
                    try {
                        const parsedContent = JSON.parse(value);
                        itemData[key] = parsedContent;
                    } catch (e) {
                        alert('Invalid JSON in resume content. Please check your formatting.');
                        return false;
                    }
                } else {
                    itemData[key] = value;
                }
            }
            
            const isNew = form.dataset.isNew === 'true';
            
            if (isNew) {
                data[currentSection].push(itemData);
            } else {
                const index = data[currentSection].findIndex(item => item.id === itemData.id);
                if (index > -1) {
                    // Preserve certain fields for updates
                    if (currentSection === 'resumes') {
                        itemData.dateModified = new Date().toISOString();
                    }
                    data[currentSection][index] = { ...data[currentSection][index], ...itemData };
                }
            }
            
            saveData();
            renderItemsList();
            closeModal();
            
            // Select the updated/new item
            const item = data[currentSection].find(item => item.id === itemData.id);
            if (item) {
                selectItem(item);
            }
            
            return true;
        }

        // Update the save item function to use the new one
        function saveItem() {
            if (currentSection === 'resumes') {
                return saveItemWithResumeData();
            }
            
            const form = document.getElementById('generic-form');
            const formData = new FormData(form);
            const itemData = {};
            
            for (const [key, value] of formData.entries()) {
                itemData[key] = value;
            }
            
            const isNew = form.dataset.isNew === 'true';
            
            if (isNew) {
                data[currentSection].push(itemData);
            } else {
                const index = data[currentSection].findIndex(item => item.id === itemData.id);
                if (index > -1) {
                    // Preserve certain fields for updates
                    if (currentSection === 'resumes') {
                        itemData.dateModified = new Date().toISOString();
                    }
                    if (currentSection === 'jobs') {
                        itemData.dateUpdated = new Date().toISOString();
                    }
                    data[currentSection][index] = { ...data[currentSection][index], ...itemData };
                }
            }
            
            saveData();
            renderItemsList();
            closeModal();
            
            // Select the updated/new item
            const item = data[currentSection].find(item => item.id === itemData.id);
            if (item) {
                selectItem(item);
            }
        }

        // Toast notification function for resume editor compatibility
        window.showToast = function(message, type = 'info') {
            const toast = document.getElementById('toast');
            if (!toast) return;
            
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        };

        // PDF Generation Functions
        window.generateResumePDF = function() {
            if (!currentItem || currentSection !== 'resumes') {
                alert('Please select a resume first.');
                return;
            }
            
            try {
                const resumeViewer = document.querySelector('#resume-viewer-details');
                if (!resumeViewer) {
                    alert('Resume preview not available. Please switch to the Preview tab first.');
                    return;
                }
                
                // Get resume data
                const resumeData = typeof currentItem.content === 'string' ? 
                    JSON.parse(currentItem.content) : currentItem.content;
                
                const fileName = `${currentItem.name || 'Resume'}.pdf`;
                
                // Configure PDF options
                const options = {
                    margin: 10,
                    filename: fileName,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                
                // Clone the resume viewer content
                const clonedElement = resumeViewer.shadowRoot.cloneNode(true);
                
                // Create a temporary container for PDF generation
                const tempContainer = document.createElement('div');
                tempContainer.style.cssText = `
                    margin: 0;
                    padding: 20px;
                    background: white;
                    width: 210mm;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    line-height: 1.6;
                    color: #333;
                `;
                
                // Copy the shadow DOM content to the temp container
                tempContainer.innerHTML = clonedElement.innerHTML;
                
                // Generate PDF
                html2pdf()
                    .set(options)
                    .from(tempContainer)
                    .save()
                    .then(() => {
                        console.log('Resume PDF generated successfully');
                        alert('✅ PDF generated successfully!');
                    })
                    .catch(error => {
                        console.error('Error generating PDF:', error);
                        alert('❌ Error generating PDF. Please try again.');
                    });
                    
            } catch (error) {
                console.error('Error generating resume PDF:', error);
                alert('❌ Error generating PDF. Please check the resume data.');
            }
        };

        window.printResume = function() {
            if (!currentItem || currentSection !== 'resumes') {
                alert('Please select a resume first.');
                return;
            }
            
            try {
                const resumeViewer = document.querySelector('#resume-viewer-details');
                if (!resumeViewer) {
                    alert('Resume preview not available. Please switch to the Preview tab first.');
                    return;
                }
                
                // Create a new window for printing
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>${currentItem.name || 'Resume'}</title>
                        <style>
                            body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; margin: 20px; }
                            @media print { body { margin: 0; } }
                        </style>
                    </head>
                    <body>
                        ${resumeViewer.shadowRoot.innerHTML}
                    </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.focus();
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                }, 500);
                
            } catch (error) {
                console.error('Error printing resume:', error);
                alert('❌ Error printing resume. Please try again.');
            }
        };

        window.generateLetterPDF = function() {
            if (!currentItem || currentSection !== 'letters') {
                alert('Please select a cover letter first.');
                return;
            }
            
            try {
                const letterContent = currentItem.content || '';
                const fileName = `${currentItem.name || 'Cover Letter'}.pdf`;
                
                // Create a formatted letter container
                const letterContainer = document.createElement('div');
                letterContainer.style.cssText = `
                    margin: 0;
                    padding: 30px;
                    background: white;
                    width: 210mm;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    line-height: 1.6;
                    color: #333;
                `;
                
                letterContainer.innerHTML = `
                    <div style="margin-bottom: 30px;">
                        <h1 style="font-size: 24px; margin-bottom: 10px;">${escapeHtml(currentItem.name || 'Cover Letter')}</h1>
                        <div style="color: #666; font-size: 14px;">
                            ${currentItem.type ? `Type: ${escapeHtml(currentItem.type.replace('_', ' ').toUpperCase())}` : ''}
                            ${currentItem.dateCreated ? ` | Created: ${new Date(currentItem.dateCreated).toLocaleDateString()}` : ''}
                        </div>
                    </div>
                    <div style="white-space: pre-line; font-size: 16px; line-height: 1.8;">
                        ${escapeHtml(letterContent)}
                    </div>
                `;
                
                const options = {
                    margin: 10,
                    filename: fileName,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                
                html2pdf()
                    .set(options)
                    .from(letterContainer)
                    .save()
                    .then(() => {
                        console.log('Cover letter PDF generated successfully');
                        alert('✅ PDF generated successfully!');
                    })
                    .catch(error => {
                        console.error('Error generating PDF:', error);
                        alert('❌ Error generating PDF. Please try again.');
                    });
                    
            } catch (error) {
                console.error('Error generating letter PDF:', error);
                alert('❌ Error generating PDF. Please check the letter content.');
            }
        };

        window.printLetter = function() {
            if (!currentItem || currentSection !== 'letters') {
                alert('Please select a cover letter first.');
                return;
            }
            
            try {
                const letterContent = currentItem.content || '';
                
                // Create a new window for printing
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>${currentItem.name || 'Cover Letter'}</title>
                        <style>
                            body { 
                                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
                                line-height: 1.6; 
                                color: #333; 
                                margin: 30px; 
                                font-size: 16px;
                            }
                            h1 { font-size: 24px; margin-bottom: 10px; }
                            .meta { color: #666; font-size: 14px; margin-bottom: 30px; }
                            .content { white-space: pre-line; line-height: 1.8; }
                            @media print { body { margin: 20px; } }
                        </style>
                    </head>
                    <body>
                        <h1>${escapeHtml(currentItem.name || 'Cover Letter')}</h1>
                        <div class="meta">
                            ${currentItem.type ? `Type: ${escapeHtml(currentItem.type.replace('_', ' ').toUpperCase())}` : ''}
                            ${currentItem.dateCreated ? ` | Created: ${new Date(currentItem.dateCreated).toLocaleDateString()}` : ''}
                        </div>
                        <div class="content">${escapeHtml(letterContent)}</div>
                    </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.focus();
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                }, 500);
                
            } catch (error) {
                console.error('Error printing letter:', error);
                alert('❌ Error printing letter. Please try again.');
            }
        };

        // Initialize the application
        init();
    </script>
</body>
</html>
