<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Resume Import</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #2980b9; }
        .status {
            padding: 10px 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .success { background: #d5f4e6; color: #27ae60; }
        .error { background: #fadbd8; color: #e74c3c; }
        .info { background: #ecf0f1; color: #2c3e50; }
        pre {
            background: #f8f8f8;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üß™ Test Resume Import</h1>

    <div class="test-section">
        <h2>Test Status</h2>
        <div id="status"></div>
    </div>

    <div class="test-section">
        <h2>Actions</h2>
        <button onclick="testResumeImport()">‚úÖ Test Resume Import</button>
        <button onclick="checkResumes()">üìã Check Resumes</button>
        <button onclick="clearResumes()">üóëÔ∏è Clear Test Resumes</button>
        <button onclick="window.location.href='/app-responsive.html'">üì± Open Main App</button>
    </div>

    <div class="test-section">
        <h2>Resume Data</h2>
        <div id="resume-data"></div>
    </div>

    <script src="js/services/indexeddb-service.js"></script>
    <script type="module">
        import { getState, setState } from './js/store.js';

        const sampleResume = {
            "basics": {
                "name": "Test User",
                "label": "Software Engineer",
                "email": "test@example.com",
                "phone": "(555) 123-4567",
                "summary": "Experienced software engineer with expertise in full-stack development."
            },
            "work": [
                {
                    "company": "Test Company",
                    "position": "Senior Engineer",
                    "startDate": "2020-01-01",
                    "endDate": "Present",
                    "highlights": ["Built amazing things", "Led great projects"]
                }
            ],
            "education": [
                {
                    "institution": "Test University",
                    "area": "Computer Science",
                    "studyType": "Bachelor",
                    "endDate": "2019-05-01"
                }
            ],
            "skills": [
                {
                    "name": "JavaScript",
                    "level": "Expert",
                    "keywords": ["React", "Node.js", "TypeScript"]
                }
            ]
        };

        function log(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.textContent = message;
            statusDiv.appendChild(div);
        }

        async function testResumeImport() {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = '';

            log('üß™ Starting resume import test...', 'info');

            try {
                // Wait for appManager to be ready
                await new Promise(resolve => {
                    const check = () => {
                        if (window.appManager) {
                            resolve();
                        } else {
                            setTimeout(check, 100);
                        }
                    };
                    check();
                });

                log('‚úÖ AppManager ready', 'success');

                // Save the section state
                const originalSection = window.appManager.currentSection;

                // Switch to resumes section
                window.appManager.currentSection = 'resumes';

                // Create test resume
                const testResume = {
                    name: 'Test Resume Import',
                    content: sampleResume,
                    data: sampleResume,
                    dateCreated: new Date().toISOString(),
                    dateModified: new Date().toISOString()
                };

                log('üíæ Saving test resume...', 'info');

                // Save via appManager
                window.appManager.saveItem(testResume, false);

                // Restore section
                window.appManager.currentSection = originalSection;

                log('‚úÖ Resume saved successfully!', 'success');
                log('üîÑ Checking if resume persisted...', 'info');

                // Wait a bit for save to complete
                await new Promise(resolve => setTimeout(resolve, 500));

                // Verify in GlobalStore
                const state = getState();
                const resumes = state?.resumes || [];
                const found = resumes.find(r => r.name === 'Test Resume Import');

                if (found) {
                    log(`‚úÖ Resume found in GlobalStore (${resumes.length} total resumes)`, 'success');
                } else {
                    log('‚ö†Ô∏è Resume not found in GlobalStore', 'error');
                }

                // Verify in IndexedDB
                await window.indexedDBService.init();
                const idbResumes = await window.indexedDBService.getResumes();
                const idbFound = idbResumes.find(r => r.name === 'Test Resume Import');

                if (idbFound) {
                    log(`‚úÖ Resume found in IndexedDB (${idbResumes.length} total)`, 'success');
                } else {
                    log('‚ö†Ô∏è Resume not found in IndexedDB', 'error');
                }

                await checkResumes();

            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                console.error('Test error:', error);
            }
        }

        async function checkResumes() {
            const dataDiv = document.getElementById('resume-data');

            try {
                await window.indexedDBService.init();
                const resumes = await window.indexedDBService.getResumes();
                const state = getState();
                const stateResumes = state?.resumes || [];

                dataDiv.innerHTML = `
                    <h3>IndexedDB Resumes (${resumes.length})</h3>
                    <pre>${JSON.stringify(resumes, null, 2)}</pre>

                    <h3>GlobalStore Resumes (${stateResumes.length})</h3>
                    <pre>${JSON.stringify(stateResumes, null, 2)}</pre>
                `;

                log(`üìä Found ${resumes.length} resumes in IndexedDB, ${stateResumes.length} in GlobalStore`, 'info');

            } catch (error) {
                log(`‚ùå Error checking resumes: ${error.message}`, 'error');
            }
        }

        async function clearResumes() {
            if (!confirm('Clear all test resumes?')) return;

            try {
                await window.indexedDBService.init();
                const resumes = await window.indexedDBService.getResumes();

                const testResumes = resumes.filter(r =>
                    r.name?.includes('Test') || r.name?.includes('test')
                );

                for (const resume of testResumes) {
                    await window.indexedDBService.deleteResume(resume.id);
                }

                // Update GlobalStore
                const state = getState();
                const remainingResumes = (state?.resumes || []).filter(r =>
                    !r.name?.includes('Test') && !r.name?.includes('test')
                );
                setState({ resumes: remainingResumes }, 'test-clear');

                log(`‚úÖ Cleared ${testResumes.length} test resumes`, 'success');
                await checkResumes();

            } catch (error) {
                log(`‚ùå Error clearing resumes: ${error.message}`, 'error');
            }
        }

        window.testResumeImport = testResumeImport;
        window.checkResumes = checkResumes;
        window.clearResumes = clearResumes;

        // Auto-check on load
        window.addEventListener('load', () => {
            setTimeout(checkResumes, 1000);
        });
    </script>

    <!-- Required components -->
    <script type="module" src="./components/global-store.js"></script>
    <script type="module" src="./js/app-manager.js"></script>
    <global-store></global-store>
</body>
</html>
