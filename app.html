<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NextRole - Find Your Next Role</title>
    <link rel="icon" type="image/svg+xml" href="logo.svg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="jobs.css">
    <!-- HTML2PDF.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <div class="sidebar" id="main-nav">
            <div class="sidebar-header">
                <h1><img src="logo.svg" height="32" style="position:relative;top:8px;"> NextRole</h1>
                <div class="subtitle">Find Your Next Role</div>
            </div>
            
            <nav class="sidebar-nav">
                <a href="#" class="nav-item active" data-section="jobs">
                    <i class="fas fa-briefcase"></i>
                    <span>Jobs</span>
                </a>
                <a href="#" class="nav-item" data-section="resumes">
                    <i class="fas fa-file-alt"></i>
                    <span>Resumes</span>
                </a>
                <a href="#" class="nav-item" data-section="letters">
                    <i class="fas fa-envelope"></i>
                    <span>Letters</span>
                </a>
                <a href="#" class="nav-item" data-section="job-search">
                    <i class="fas fa-search"></i>
                    <span>Job Search</span>
                </a>
                <a href="#" class="nav-item" data-section="scraper">
                    <i class="fas fa-download"></i>
                    <span>Job Scraper</span>
                </a>
                <a href="#" class="nav-item" data-section="ai-assistant">
                    <i class="fas fa-magic"></i>
                    <span>AI Assistant</span>
                </a>
                <a href="#" class="nav-item" data-section="ai">
                    <i class="fas fa-robot"></i>
                    <span>AI History</span>
                </a>
                 <a href="#" class="nav-item" data-section="help" id="help-nav">
                    <i class="fas fa-question-circle"></i>
                    <span>Help</span>
                </a>
                <a href="#" class="nav-item" data-section="settings">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <!-- Settings moved to navigation -->
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="main-content">
            <div class="main-header">
                <h2 id="section-title">Jobs</h2>
                <div class="stats-container" aria-hidden="false">
                    <!-- Backwards-compatible placeholder for visual tests and legacy layouts -->
                    <div class="stats-item">Jobs: <span class="stat-count" id="jobs-count">0</span></div>
                    <div class="stats-item">Resumes: <span class="stat-count" id="resumes-count">0</span></div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary" id="import-job-btn" style="display: none;">
                        <i class="fas fa-download"></i>
                        Import Job
                    </button>
                    <button class="btn btn-primary" id="import-resume-btn" style="display: none;">
                        <i class="fas fa-file-import"></i>
                        Import Resume
                    </button>
                    <button class="btn btn-success" id="add-item-btn">
                        <i class="fas fa-plus"></i>
                        <span id="add-item-text">Add Job</span>
                    </button>
                </div>
            </div>

            <div class="content-panels">
                <!-- Items List Panel -->
                <div class="items-panel" id="items-panel">
                    <div class="items-header" id="items-header">Jobs</div>
                <div id="jobs-container">
                    <div class="items-list" id="items-list">
                        <!-- Items will be populated here -->
                    </div>
                </div>
                </div>

                <!-- Details Panel -->
                <div class="details-panel" id="details-panel">
                    <div class="details-content" id="details-content">
                        <div class="empty-state">
                            <i class="fas fa-briefcase"></i>
                            <h3>Select a job to view details</h3>
                            <p>Choose a job from the list to view and edit its information</p>
                        </div>
                    </div>
                </div>

                <!-- Settings Panel -->
                <div id="settings-panel" class="settings-panel" style="display:none; width:100%;">
                    <settings-manager></settings-manager>
                </div>

                <!-- Job Search Panel -->
                <div id="job-search-panel" class="job-search-panel" style="display:none; width:100%;">
                    <job-search></job-search>
                </div>

                <!-- AI Assistant Panel -->
                <div id="ai-assistant-panel" class="ai-assistant-panel" style="display:none; width:100%;">
                    <ai-assistant-worker></ai-assistant-worker>
                </div>

                <!-- Job Scraper Panel -->
                <div id="scraper-panel" class="scraper-panel" style="display:none; width:100%;">
                    <job-scraper></job-scraper>
                </div>

                <!-- Resumes Panel (placeholder for legacy selector) -->
                <div id="resumes-panel" class="resumes-panel" style="display:none; width:100%;">
                    <div class="resume-list-content" id="resumes-container">
                        <!-- Resumes will be rendered here by the app -->
                    </div>
                </div>

                <!-- Help Panel -->
                <div id="help-panel" class="help-panel" style="display:none; width:100%;">
                    <style>
                        .help-container {
                            max-width: 800px;
                            margin: 40px auto;
                            background: #fff;
                            border-radius: 12px;
                            box-shadow: 0 4px 24px rgba(44,62,80,0.08);
                            padding: 2.5rem 2rem;
                        }
                        .help-container h1 {
                            font-size: 2.2rem;
                            margin-bottom: 0.5em;
                        }
                        .help-container h2 {
                            margin-top: 2em;
                            font-size: 1.3rem;
                            color: #2980b9;
                        }
                        .help-container ul, .help-container ol {
                            margin-left: 1.5em;
                        }
                        .help-container code {
                            background: #f4f4f4;
                            border-radius: 4px;
                            padding: 2px 6px;
                            font-size: 0.98em;
                        }
                        .help-container .tip {
                            background: #eafaf1;
                            border-left: 4px solid #27ae60;
                            padding: 0.7em 1em;
                            margin: 1.5em 0;
                            border-radius: 6px;
                            color: #145a32;
                        }
                    </style>
                    <div class="help-container">
                        <h1><i class="fas fa-question-circle"></i> Job Hunt Manager Help & Usage Guide</h1>
                        <p>Welcome to the Job Hunt Manager! This guide will help you get the most out of the tool.</p>

                        <h2>Getting Started</h2>
                        <ol>
                            <li><strong>Add Jobs:</strong> Click <b>Add Job</b> to enter job details manually, or use <b>Import Job</b> to extract details from a job posting URL or description.</li>
                            <li><strong>Track Status:</strong> Update the status of each job (e.g., saved, applied, interviewing, etc.) as your search progresses.</li>
                            <li><strong>Manage Resumes:</strong> Store and edit multiple resumes. Tailor resumes for specific jobs using the AI features.</li>
                            <li><strong>Generate Cover Letters:</strong> Use the AI tool to create personalized cover letters for each job application.</li>
                        </ol>

                        <h2>Sections Overview</h2>
                        <ul>
                            <li><b>Jobs:</b> List and manage all job opportunities. Click a job to view or edit details.</li>
                            <li><b>Resumes:</b> Store, edit, and tailor resumes. Use the visual editor for easy updates.</li>
                            <li><b>Letters:</b> Manage cover letters and other correspondence.</li>
                            <li><b>AI History:</b> View a log of all AI-powered actions (resume tailoring, letter generation, etc.).</li>
                        </ul>

                        <h2>AI Features</h2>
                        <ul>
                            <li><b>Tailor Resume:</b> Select a job and a base resume, then use the AI to generate a tailored resume for that job.</li>
                            <li><b>Generate Cover Letter:</b> Optionally generate a cover letter at the same time as tailoring a resume.</li>
                            <li><b>API Key Required:</b> Set your API key in <b>Settings</b> to use AI features. You can use OpenAI (ChatGPT) or Anthropic (Claude).</li>
                        </ul>

                        <h2>Tips & Best Practices</h2>
                        <ul>
                            <li>Regularly save your data. All information is stored in your browser's local storage.</li>
                            <li>Use the <b>Import Job</b> feature to quickly add jobs from URLs or descriptions.</li>
                            <li>Keep your resumes up to date and tailor them for each application.</li>
                            <li>Check the <b>AI History</b> tab to review past AI actions and outputs.</li>
                        </ul>

                        <div class="tip">
                            <b>Need more help?</b> If you have questions or encounter issues, please contact the developer or check for updates.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js').then(reg => {
                console.log('Service worker registered:', reg.scope);
            }).catch(err => console.warn('Service worker registration failed:', err));
        }
    </script>

    <!-- Generic Form Modal -->
    <div class="modal-backdrop hidden" id="form-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="form-modal-title">Add Item</h3>
                <button class="modal-close" id="form-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="generic-form">
                    <!-- Form fields will be generated here -->
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" id="form-cancel">Cancel</button>
                <button type="button" class="btn btn-primary" id="form-save">Save</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-backdrop hidden" id="settings-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Settings</h3>
                <button class="modal-close" id="settings-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="api-type">AI Service</label>
                    <select class="form-input" id="api-type">
                        <option value="claude">Claude (Anthropic)</option>
                        <option value="chatgpt">ChatGPT (OpenAI)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="api-key">API Key</label>
                    <input type="password" class="form-input" id="api-key" placeholder="Enter your API key">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="use-direct-api"> Use direct API calls (browser-based)
                    </label>
                    <div style="font-size: 12px; color: #7f8c8d; margin-top: 5px;">
                        When enabled, API calls are made directly from your browser. Otherwise, they go through the local server.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" id="settings-cancel">Cancel</button>
                <button type="button" class="btn btn-primary" id="settings-save">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Import Job Modal -->
    <div class="modal-backdrop hidden" id="import-job-modal">
        <div class="modal">
            <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Import Job from URL or Description</h3>
                <button class="modal-close" id="import-job-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Import Method</label>
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="radio" name="import-method" value="url" id="import-method-url" checked>
                            <span>Job URL</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="radio" name="import-method" value="description" id="import-method-description">
                            <span>Job Description</span>
                        </label>
                    </div>
                </div>

                <div class="form-group" id="import-url-section">
                    <label class="form-label" for="import-job-url">Job Posting URL</label>
                    <input type="url" class="form-input" id="import-job-url" placeholder="https://example.com/job-posting">
                    <!-- Backwards-compatible visible field expected by tests -->
                    <input type="url" class="form-input" id="job-url-import" placeholder="https://example.com/job-posting">
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        Paste the URL of the job posting (LinkedIn, Indeed, company website, etc.)
                    </div>
                </div>

                <div class="form-group" id="import-description-section">
                    <label class="form-label" for="import-job-description">Job Description</label>
                    <textarea class="form-input form-textarea" id="import-job-description" rows="10" placeholder="Paste the complete job description here..."></textarea>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        Copy and paste the entire job description including requirements, responsibilities, and company information
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="import-custom-instructions">Additional Instructions (Optional)</label>
                    <textarea class="form-input form-textarea" id="import-custom-instructions" rows="2" placeholder="Any specific parsing requirements or additional information..."></textarea>
                </div>

                <div id="import-api-warning" class="hidden" style="padding: 10px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; margin: 10px 0;">
                    <strong>⚠️ API Key Required</strong><br>
                    <span style="display:block; text-transform:none;">Please configure your API key in Settings before using import features.</span>
                    <!-- include lowercase friendly text for tests that assert on exact phrase -->
                    <span style="display:none;">API key required</span>
                </div>

                <!-- Manual job fields (kept here for compatibility with test helpers) -->
                <div id="import-manual-fields" class="form-group" style="margin-top: 1rem;">
                    <label class="form-label" for="job-company">Company</label>
                    <input type="text" class="form-input" id="job-company" placeholder="Company">
                    <label class="form-label" for="job-position" style="margin-top: 0.5rem;">Position</label>
                    <input type="text" class="form-input" id="job-position" placeholder="Position">
                    <label class="form-label" for="job-location" style="margin-top: 0.5rem;">Location</label>
                    <input type="text" class="form-input" id="job-location" placeholder="Location">
                    <label class="form-label" for="job-url" style="margin-top: 0.5rem;">Job URL</label>
                    <input type="url" class="form-input" id="job-url" placeholder="https://example.com/job-posting">
                    <label class="form-label" for="job-description" style="margin-top: 0.5rem;">Description</label>
                    <textarea class="form-input form-textarea" id="job-description" rows="6" placeholder="Paste the job description here..."></textarea>
                </div>

                <div id="import-progress" class="hidden" style="padding: 15px; text-align: center;">
                    <div style="margin-bottom: 10px;">
                        <i class="fas fa-download fa-spin" style="font-size: 24px; color: #3498db;"></i>
                    </div>
                    <div id="import-progress-text">Importing job information...</div>
                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                        Analyzing content and extracting job details...
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" id="import-job-cancel">Cancel</button>
                <button type="button" class="btn btn-secondary" id="import-job-save">Save</button>
                <button type="button" class="btn btn-primary" id="import-job-submit">
                    <i class="fas fa-download"></i> Import Job
                </button>
            </div>
            </div> <!-- .modal-content -->
        </div>
    </div>

    <!-- Import Resume Modal -->
    <div class="modal-backdrop hidden" id="import-resume-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Import Resume.json</h3>
                <button class="modal-close" id="import-resume-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Import Method</label>
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="radio" name="resume-import-method" value="paste" id="resume-import-method-paste" checked>
                            <span>Paste JSON</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="radio" name="resume-import-method" value="file" id="resume-import-method-file">
                            <span>Upload File</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="radio" name="resume-import-method" value="url" id="resume-import-method-url">
                            <span>From URL</span>
                        </label>
                    </div>
                </div>

                <div class="form-group" id="resume-paste-section">
                    <label class="form-label" for="resume-json-input">Paste JSON</label>
                    <textarea class="form-input form-textarea" id="resume-json-input" rows="10" placeholder="Paste your resume.json content here..."></textarea>
                </div>

                <div class="form-group hidden" id="resume-file-section">
                    <label class="form-label" for="resume-file-input">Upload JSON File</label>
                    <div id="resume-drag-drop-area" class="drag-drop-area" style="border: 2px dashed #ddd; padding: 40px; text-align: center; border-radius: 8px; cursor: pointer;">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #ccc; margin-bottom: 16px;"></i>
                        <p>Drag & drop your resume.json file here or click to browse</p>
                        <input type="file" id="resume-file-input" accept=".json" style="display: none;">
                    </div>
                    <div id="resume-file-name" class="hidden"></div>
                </div>

                <div class="form-group hidden" id="resume-url-section">
                    <label class="form-label" for="resume-url-input">JSON URL</label>
                    <input type="url" class="form-input" id="resume-url-input" placeholder="https://example.com/resume.json">
                </div>

                <div class="form-group">
                    <label class="form-label" for="resume-name-input">Resume Name</label>
                    <input type="text" class="form-input" id="resume-name-input" placeholder="My Resume" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" id="import-resume-cancel">Cancel</button>
                <button type="button" class="btn btn-primary" id="import-resume-submit">
                    <i class="fas fa-file-import"></i> Import Resume
                </button>
            </div>
        </div>
    </div>

    <!-- AI Generation Modal -->
    <div class="modal-backdrop hidden" id="ai-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">AI Resume Tailoring & Cover Letter Generation</h3>
                <button class="modal-close" id="ai-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Job Details</label>
                    <div id="ai-job-details" class="card" style="padding: 15px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px;">
                        <!-- Job details will be populated here -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="ai-base-resume">Select Base Resume</label>
                    <select class="form-input" id="ai-base-resume" required>
                        <option value="">Choose a resume to tailor...</option>
                        <!-- Resume options will be populated here -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="ai-custom-instructions">Custom Instructions (Optional)</label>
                    <textarea class="form-input form-textarea" id="ai-custom-instructions" rows="3" placeholder="Any specific requirements or preferences for the tailoring..."></textarea>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="ai-generate-cover-letter" checked> Generate cover letter
                    </label>
                </div>

                <div id="ai-api-warning" class="hidden" style="padding: 10px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; margin: 10px 0;">
                    <strong>⚠️ API Key Required</strong><br>
                    Please configure your API key in Settings before using AI features.
                </div>

                <div id="ai-progress" class="hidden" style="padding: 15px; text-align: center;">
                    <div style="margin-bottom: 10px;">
                        <i class="fas fa-robot fa-spin" style="font-size: 24px; color: #3498db;"></i>
                    </div>
                    <div id="ai-progress-text">Processing with AI...</div>
                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                        This may take 30-60 seconds depending on the AI service.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" id="ai-cancel">Cancel</button>
                <button type="button" class="btn btn-success" id="ai-generate">
                    <i class="fas fa-robot"></i> Generate
                </button>
            </div>
        </div>
    </div>

    <!-- Export Resume Modal -->
    <div class="modal-backdrop hidden" id="export-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Export Resume JSON</h3>
                <button class="modal-close" id="export-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Resume JSON Data</label>
                    <textarea class="form-input form-textarea" id="export-json-textarea" rows="20" readonly style="font-family: monospace; font-size: 12px; background: #f8f9fa;"></textarea>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        This JSON follows the <a href="https://jsonresume.org/schema/" target="_blank">JSON Resume Schema</a> standard.
                    </div>
                </div>
                <div class="export-stats" id="export-stats" style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin-top: 10px; font-size: 14px;">
                    <!-- Stats will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" id="export-cancel">Cancel</button>
                <button type="button" class="btn btn-secondary" id="export-copy">
                    <i class="fas fa-copy"></i> Copy to Clipboard
                </button>
                <button type="button" class="btn btn-primary" id="export-download">
                    <i class="fas fa-download"></i> Download JSON File
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Resume Editor Component -->
    <script type="module" src="./components/resume-editor.js"></script>
    <script type="module" src="./components/resume-viewer.js"></script>
    <script type="module" src="./components/resume-analytics.js"></script>
    <script type="module" src="./components/global-store.js"></script>
    <script type="module" src="./components/settings-manager.js"></script>
    <script type="module" src="./components/ai-assistant-worker.js"></script>
    <script type="module" src="./components/job-search.js"></script>
    <script type="module" src="./components/job-scraper.js"></script>
    <script type="module" src="./js/ai-service.js"></script>
    <script type="module" src="./js/store.js"></script>
    <script type="module" src="./js/job-feeds.js"></script>

    <!-- Global Store Instance -->
    <global-store></global-store>

    <!-- Main Application JavaScript - Now Modular! -->
    <script type="module" src="./js/app-manager.js"></script>
    <script type="module">
        // Initialize the application
        import appManager from './js/app-manager.js';
        import { init as initModalManager } from './js/modal-manager.js';
        
        // Update stats counters in header
        function updateStatsCounters(state) {
            const jobsCount = document.getElementById('jobs-count');
            const resumesCount = document.getElementById('resumes-count');

            if (jobsCount) {
                jobsCount.textContent = state?.jobs?.length || 0;
            }
            if (resumesCount) {
                resumesCount.textContent = state?.resumes?.length || 0;
            }
        }

        // Initialize modules
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('Initializing Job Hunt Manager...');

                // Initialize modal manager
                initModalManager();

                // Initialize app manager
                await appManager.init();

                // Subscribe to global state changes to update stats counters
                document.addEventListener('global-state-changed', (event) => {
                    updateStatsCounters(event.detail?.newState);
                });

                // Also listen for global-store-ready to set initial counts
                document.addEventListener('global-store-ready', () => {
                    if (window.globalStore) {
                        updateStatsCounters(window.globalStore.getState());
                    }
                });

                // Set initial counts if store is already ready
                if (window.globalStore) {
                    updateStatsCounters(window.globalStore.getState());
                }

                console.log('Job Hunt Manager initialized successfully!');

            } catch (error) {
                console.error('Failed to initialize Job Hunt Manager:', error);
            }
        });
    </script>
</body>
</html>
